
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>Split-Operator Method · Arcane Algorithm Archive</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 3.6.22">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-bibtex-cite/style.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-api-language-selector/api-language-selector.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../data_compression/data_compression.html" />
    
    
    <link rel="prev" href="../quantum_systems/quantum_systems.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Algorithm Archive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../introduction/introduction.html">
            
                <a href="../introduction/introduction.html">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../how_to_contribute/how_to_contribute.html">
            
                <a href="../how_to_contribute/how_to_contribute.html">
            
                    
                    How To Contribute
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../plotting/plotting.html">
            
                <a href="../plotting/plotting.html">
            
                    
                    Plotting
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../domain_coloring/domain_coloring.html">
            
                <a href="../domain_coloring/domain_coloring.html">
            
                    
                    Domain Coloring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../IFS/IFS.html">
            
                <a href="../IFS/IFS.html">
            
                    
                    Iterated Function Systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../barnsley/barnsley.html">
            
                <a href="../barnsley/barnsley.html">
            
                    
                    The Barnsley Fern
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../data_structures/data_structures.html">
            
                <a href="../data_structures/data_structures.html">
            
                    
                    Data Structures
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../stacks_and_queues/stacks_and_queues.html">
            
                <a href="../stacks_and_queues/stacks_and_queues.html">
            
                    
                    Stacks and Queues
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../mathematical_background/mathematical_background.html">
            
                <a href="../mathematical_background/mathematical_background.html">
            
                    
                    Mathematical Background
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../notation/notation.html">
            
                <a href="../notation/notation.html">
            
                    
                    Complexity Notation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../affine_transformations/affine_transformations.html">
            
                <a href="../affine_transformations/affine_transformations.html">
            
                    
                    Affine Transformations
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../bitlogic/bitlogic.html">
            
                <a href="../bitlogic/bitlogic.html">
            
                    
                    Bit Logic
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../taylor_series_expansion/taylor_series_expansion.html">
            
                <a href="../taylor_series_expansion/taylor_series_expansion.html">
            
                    
                    Taylor Series
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../convolutions/convolutions.html">
            
                <a href="../convolutions/convolutions.html">
            
                    
                    Convolutions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.5.1" data-path="../convolutions/1d/1d.html">
            
                <a href="../convolutions/1d/1d.html">
            
                    
                    Convolutions in 1D
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.2" data-path="../convolutions/multiplication/multiplication.html">
            
                <a href="../convolutions/multiplication/multiplication.html">
            
                    
                    Multiplication as a Convolution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.3" data-path="../convolutions/2d/2d.html">
            
                <a href="../convolutions/2d/2d.html">
            
                    
                    Convolutions of Images (2D)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5.4" data-path="../convolutions/convolutional_theorem/convolutional_theorem.html">
            
                <a href="../convolutions/convolutional_theorem/convolutional_theorem.html">
            
                    
                    Convolutional Theorem
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../tree_traversal/tree_traversal.html">
            
                <a href="../tree_traversal/tree_traversal.html">
            
                    
                    Tree Traversal
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../euclidean_algorithm/euclidean_algorithm.html">
            
                <a href="../euclidean_algorithm/euclidean_algorithm.html">
            
                    
                    Euclidean Algorithm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../monte_carlo_integration/monte_carlo_integration.html">
            
                <a href="../monte_carlo_integration/monte_carlo_integration.html">
            
                    
                    Monte Carlo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../matrix_methods/matrix_methods.html">
            
                <a href="../matrix_methods/matrix_methods.html">
            
                    
                    Matrix Methods
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="../gaussian_elimination/gaussian_elimination.html">
            
                <a href="../gaussian_elimination/gaussian_elimination.html">
            
                    
                    Gaussian Elimination
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="../thomas_algorithm/thomas_algorithm.html">
            
                <a href="../thomas_algorithm/thomas_algorithm.html">
            
                    
                    Thomas Algorithm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="../computational_geometry/computational_geometry.html">
            
                <a href="../computational_geometry/computational_geometry.html">
            
                    
                    Computational Geometry
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../gift_wrapping/gift_wrapping.html">
            
                <a href="../gift_wrapping/gift_wrapping.html">
            
                    
                    Gift Wrapping
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1.1" data-path="../jarvis_march/jarvis_march.html">
            
                <a href="../jarvis_march/jarvis_march.html">
            
                    
                    Jarvis March
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11.1.2" data-path="../graham_scan/graham_scan.html">
            
                <a href="../graham_scan/graham_scan.html">
            
                    
                    Graham Scan
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="../cooley_tukey/cooley_tukey.html">
            
                <a href="../cooley_tukey/cooley_tukey.html">
            
                    
                    FFT
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="../decision_problems/decision_problems.html">
            
                <a href="../decision_problems/decision_problems.html">
            
                    
                    Decision Problems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../stable_marriage_problem/stable_marriage_problem.html">
            
                <a href="../stable_marriage_problem/stable_marriage_problem.html">
            
                    
                    Stable Marriage Problem
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../differential_equations/differential_equations.html">
            
                <a href="../differential_equations/differential_equations.html">
            
                    
                    Differential Equation Solvers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="../forward_euler_method/forward_euler_method.html">
            
                <a href="../forward_euler_method/forward_euler_method.html">
            
                    
                    Forward Euler Method
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="../physics_solvers/physics_solvers.html">
            
                <a href="../physics_solvers/physics_solvers.html">
            
                    
                    Physics Solvers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../verlet_integration/verlet_integration.html">
            
                <a href="../verlet_integration/verlet_integration.html">
            
                    
                    Verlet Integration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../quantum_systems/quantum_systems.html">
            
                <a href="../quantum_systems/quantum_systems.html">
            
                    
                    Quantum Systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.15.2.1" data-path="split-operator_method.html">
            
                <a href="split-operator_method.html">
            
                    
                    Split-Operator Method
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../data_compression/data_compression.html">
            
                <a href="../data_compression/data_compression.html">
            
                    
                    Data Compression
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.16.1" data-path="../huffman_encoding/huffman_encoding.html">
            
                <a href="../huffman_encoding/huffman_encoding.html">
            
                    
                    Huffman Encoding
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="../computer_graphics/computer_graphics.html">
            
                <a href="../computer_graphics/computer_graphics.html">
            
                    
                    Computer Graphics
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="../flood_fill/flood_fill.html">
            
                <a href="../flood_fill/flood_fill.html">
            
                    
                    Flood Fill
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.18" data-path="../quantum_information/quantum_information.html">
            
                <a href="../quantum_information/quantum_information.html">
            
                    
                    Quantum Information
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.19" data-path="../computus/computus.html">
            
                <a href="../computus/computus.html">
            
                    
                    Computus
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.20" data-path="../approximate_counting/approximate_counting.html">
            
                <a href="../approximate_counting/approximate_counting.html">
            
                    
                    Approximate Counting Algorithm
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Split-Operator Method</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="the-split-operator-method">The Split-Operator Method</h1>
<p>The Split-Operator Method (also called the Split-Step Method), was actually the primary method I used to solve the Schrödinger equation during my PhD.
It is one of the simplest and fastest methods for this purpose and is widely used throughout modern quantum research in the area, in particular when dealing with the Non-linear Schrödinger Equation (NLSE):</p>
<p><script type="math/tex; mode=display">
i \hbar \frac{\partial \Psi(\mathbf{r},t)}{\partial t} = \left[-\frac{\hbar^2}{2m}\nabla^2 + V(\mathbf{r}) + g|\Psi(\mathbf{r},t)|^2 \right] \Psi(\mathbf{r},t),
</script></p>
<p>which follows from the notation provided in the <a href="../quantum_systems/quantum_systems.html">quantum systems</a> chapter: <script type="math/tex; ">\Psi(\mathbf{r},t)</script> is a quantum wave-function with spatial (<script type="math/tex; ">\mathbf{r}</script>) and time (<script type="math/tex; ">t</script>) dependence, <script type="math/tex; ">\nabla^2</script> is a Laplacian, and <script type="math/tex; ">V(\mathbf{r})</script> is a potential of some sort (like <script type="math/tex; ">\omega x^2</script> or something).
In this case, we also add an interaction term <script type="math/tex; ">g</script> next to a nonlinear <script type="math/tex; ">|\Psi(\mathbf{r},t)|^2</script> term.
This is the system I studied for most of my PhD (granted, we played a few tricks with parallelization and such, so it was <em>slightly</em> more complicated).</p>
<p>At its heart, the split-op method is nothing more than a pseudo-spectral differential equation solver... That is to say, it solves the Schrödinger equation with <a href="../cooley_tukey/cooley_tukey.html">FFTs</a>.
In fact, there is a large class of spectral and pseudo-spectral methods used to solve a number of different physical systems, and we&apos;ll definitely be covering those in the future.
As mentioned in the <a href="../quantum_systems/quantum_systems.html">quantum systems</a> section, we can represent a quantum wavefunction in momentum space, which is parameterized with the wavevector <script type="math/tex; ">k</script>.
In the Hamiltonian shown above, we can split our system into position space components, <script type="math/tex; ">\hat{H}_r = \left[V(\mathbf{r}) + g|\Psi(\mathbf{r},t)|^2 \right] \Psi(\mathbf{r},t)</script>, and momentum space components, <script type="math/tex; ">\hat{H}_k = \left[-\frac{\hbar^2}{2m}\nabla^2 \right]\Psi(\mathbf{r},t)</script>.
I&apos;ll be honest, I didn&apos;t know what notation to use for <script type="math/tex; ">\hat H_r</script> because <script type="math/tex; ">p</script> is used to describe momentum.
I settled on <script type="math/tex; ">r</script> for <em>real space</em>, but that is somewhat notationally ambiguous.
In addition, <script type="math/tex; ">k</script> will indicate momentum space because it is a sum of all wavevectors, typically notated as <script type="math/tex; ">k</script>.
Bad notation aside, let&apos;s continue.</p>
<p>If we assume a somewhat general solution to our quantum system:</p>
<p><script type="math/tex; mode=display">
\Psi(\mathbf{r},t + dt) = \left[e^{-\frac{i\hat{H}dt}{\hbar}}\right]\Psi(\mathbf{r},t) = \left[e^{-\frac{i(\hat{H}_r + \hat{H}_k)dt}{\hbar}}\right]\Psi(\mathbf{r},t)
</script></p>
<p>and assume we are simulating our system by a series of small timesteps (<script type="math/tex; ">dt</script>), we can perform similar splitting by using the Baker-Campbell-Housdorff formula:</p>
<p><script type="math/tex; mode=display">
\Psi(\mathbf{r},t+dt) = \left[e^{-\frac{i\hat{H}_rdt}{\hbar}}e^{-\frac{i\hat{H}_kdt}{\hbar}}e^{-\frac{[i\hat{H}_r, i\hat{H}_k]dt^2}{2}}\right]\Psi(\mathbf{r},t)
</script></p>
<p>This accrues a small amount of error (<script type="math/tex; ">dt^2</script>) related to the commutation of the real and momentum-space components of the Hamiltonian.
This is a relatively large error and that&apos;s not okay.
In order to change the <script type="math/tex; ">dt^2</script> error to <script type="math/tex; ">dt^3</script>, we can split the system by performing a half-step in position space before doing a full-step in momentum space, through a process called <em>Strang Splitting</em> like so:</p>
<p><script type="math/tex; mode=display">
\Psi(\mathbf{r},t+dt) = \left[e^{-\frac{i\hat{H}_rdt}{2\hbar}}e^{-\frac{i\hat{H}_kdt}{\hbar}}e^{-\frac{i\hat{H}_rdt}{2\hbar}} \right]\Psi(\mathbf{r},t) + \mathcal{O}(dt^3)
</script></p>
<p>We can then address each part of this solution in chunks, first in position space, then in momentum space, then in position space again by using <a href="../cooley_tukey/cooley_tukey.html">Fourier Transforms</a>.
Which looks something like this:</p>
<p><script type="math/tex; mode=display">
\Psi(\mathcal{r}, t+dt) = \left[\hat{U}_r\left(\frac{dt}{2}\right)\mathcal{F}^{-1}\left[\hat{U}_k(dt) \mathcal{F} \left[\hat{U}_r\left(\frac{dt}{2}\right) \Psi(\mathbf{r},t) \right] \right] \right] + \mathcal{O}(dt^3)
</script></p>
<p>where <script type="math/tex; ">\hat{U}_r = e^{-\frac{i\hat{H}_rdt}{\hbar}}</script>, <script type="math/tex; ">\hat{U}_k = e^{-\frac{i\hat{H}_kdt}{\hbar}}</script>, and <script type="math/tex; ">\mathcal{F}</script> and <script type="math/tex; ">\mathcal{F}^{-1}</script> indicate forward and inverse Fourier Transforms.
Here&apos;s a flowchart of what we are looking for every timestep:</p>
<p>
    <img class="center" src="res/split_op_method.svg" style="width:70%">
</p>


<p>For the most part, that&apos;s it:</p>
<ol>
<li>Multiply the wavefunction in real space with the real-space operator.</li>
<li>Flip to momentum space with a Fourier transform.</li>
<li>Multiply the momentum-space wavefunction by the momentum-space operator.</li>
<li>Flip to position space with an inverse Fourier transform.</li>
<li>Repeat 1-4 until satisfied.</li>
</ol>
<p>If we guess that our initial wavefunction is Gaussian-like and is slightly offset from the center or the trap, this should allow us to see our wavefunction &quot;sloshing&quot; back and forth in our trap, like so:</p>
<p>
    <img class="center" src="res/real_time.gif" style="width:70%">
</p>

<p>As a small concession, using this method enforces periodic boundary conditions, where the wavefunction will simply slide from one side of your simulation box to the other, but that&apos;s fine for most cases.
In fact, for many cases (such as large-scale turbulence models) it&apos;s ideal.</p>
<p>That said, there is more to the story.
As we mentioned in the <a href="../quantum_systems/quantum_systems.html">quantum systems</a> section, many simulations of quantum systems desire to find the ground state of our system.
The split-operator method can be used for that too!
If we run this simulation in <em>imaginary time</em>, by simply setting <script type="math/tex; ">\tau = it</script> and stepping through <script type="math/tex; ">\tau</script> instead of <script type="math/tex; ">t</script>, we will no longer see an &quot;real-world&quot; example of how the atoms should behave, but will instead see an exponential decay of higher-energy states.
If we run the simulation for long enough with a small enough timestep, all higher energy states will vanish.
This means that we can find the ground state of our system by running the simulation in imaginary time, which is an incredibly useful feature!
If we run the same simulation as above in imaginary time, we should see our wavefunction smoothly move to the center of our trap (the lowest energy position), like so:</p>
<p>
    <img class="center" src="res/imaginary_time.gif" style="width:70%">
</p>


<h2 id="the-algorithm">The Algorithm</h2>
<p>Luckily, the code in this case is pretty straightforward.
As a note before starting, we will be using normalized units in this simulation where <script type="math/tex; ">\hbar = c = 1</script>.
These units are often called <em>natural</em> units.
Many of you (<em>cough</em> experimentalists <em>cough</em>) will probably think that these units are completely unphysical, and they are; however, they allow us to output fractions and whole numbers.
For example, if we are trying to find the energy of the ground state of atoms in a simple harmonic oscillator, we know it should be <script type="math/tex; ">\frac{1}{2}\hbar \omega</script>, where <script type="math/tex; ">\omega</script> is the coefficient in front of the <script type="math/tex; ">x^2</script> term known as the <em>frequency</em> of the trap.
If we were to calculate the energy in real units, our simulation would output <script type="math/tex; ">5.272859 \times 10^{-35}</script>, which is hard to interpret.
By instead using natural units, we get precisely <script type="math/tex; ">\frac{1}{2}</script> and we know that those are in units of <script type="math/tex; ">\hbar\omega</script>.
There is no doubt that it makes the simulation easier to understand (albeit a little misleading in the end).</p>
<p>Regardless, we first need to set all the initial parameters, including the initial grids in real and momentum space:</p>
<div class="code-method"><div class="code-method-definition"></div><div class="code-method-code"><div class="code-method-sample" data-lang="jl" data-name="Julia"><pre class="language-"><code class="lang-julia"><span class="token keyword">struct</span> Param
    xmax<span class="token punctuation">::</span>Float64
    res<span class="token punctuation">::</span>Int64
    dt<span class="token punctuation">::</span>Float64
    timesteps<span class="token punctuation">::</span>Int64
    dx<span class="token punctuation">::</span>Float64
    x<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span>
    dk<span class="token punctuation">::</span>Float64
    k<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span>
    im_time<span class="token punctuation">::</span>Bool

    Param<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> new<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">10.0</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">,</span>
                  Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10.0</span> <span class="token operator">+</span> <span class="token number">10.0</span><span class="token operator">/</span><span class="token number">512</span> <span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token operator">/</span><span class="token number">512</span> <span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token constant">pi</span> <span class="token operator">/</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
                  Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span>vcat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">pi</span><span class="token operator">/</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token boolean">false</span><span class="token punctuation">)</span>
    Param<span class="token punctuation">(</span>xmax<span class="token punctuation">::</span>Float64<span class="token punctuation">,</span> res<span class="token punctuation">::</span>Int64<span class="token punctuation">,</span> dt<span class="token punctuation">::</span>Float64<span class="token punctuation">,</span> timesteps<span class="token punctuation">::</span>Int64<span class="token punctuation">,</span>
          im_val<span class="token punctuation">::</span>Bool<span class="token punctuation">)</span> <span class="token operator">=</span> new<span class="token punctuation">(</span>
              xmax<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dt<span class="token punctuation">,</span> timesteps<span class="token punctuation">,</span>
              <span class="token number">2</span><span class="token operator">*</span>xmax<span class="token operator">/</span>res<span class="token punctuation">,</span> Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">-</span>xmax<span class="token operator">+</span>xmax<span class="token operator">/</span>res<span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>xmax<span class="token operator">/</span>res<span class="token punctuation">:</span>xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token constant">pi</span><span class="token operator">/</span>xmax<span class="token punctuation">,</span> Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span>vcat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>res<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span>res<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token constant">pi</span><span class="token operator">/</span><span class="token punctuation">(</span>xmax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              im_val
          <span class="token punctuation">)</span>
<span class="token keyword">end</span>
</code></pre>
</div><div class="code-method-sample" data-lang="c" data-name="C"><pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">params</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> xmax<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dt<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timesteps<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">double</span> <span class="token operator">*</span>x<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dk<span class="token punctuation">;</span>
    <span class="token keyword">double</span> <span class="token operator">*</span>k<span class="token punctuation">;</span>
    bool im_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-c"><span class="token keyword">void</span> <span class="token function">init_params</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">params</span> <span class="token operator">*</span>par<span class="token punctuation">,</span> <span class="token keyword">double</span> xmax<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> res<span class="token punctuation">,</span> <span class="token keyword">double</span> dt<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timesteps<span class="token punctuation">,</span> bool im<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    par<span class="token operator">-&gt;</span>xmax <span class="token operator">=</span> xmax<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>dt <span class="token operator">=</span> dt<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>timesteps <span class="token operator">=</span> timesteps<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>dx <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>x <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token operator">*</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>dk <span class="token operator">=</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>k <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token operator">*</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>im_time <span class="token operator">=</span> im<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        par<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> xmax <span class="token operator">/</span> res <span class="token operator">-</span> xmax <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            par<span class="token operator">-&gt;</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            par<span class="token operator">-&gt;</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>i <span class="token operator">-</span> res<span class="token punctuation">)</span> <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="code-method-sample" data-lang="cpp" data-name="C++"><pre class="language-"><code class="lang-cpp"><span class="token keyword">using</span> complex <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> vector_real <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> vector_complex <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>complex<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Params</span> <span class="token punctuation">{</span>
    <span class="token function">Params</span><span class="token punctuation">(</span><span class="token keyword">double</span> _xmax<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> _res<span class="token punctuation">,</span> <span class="token keyword">double</span> _dt<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> _timesteps<span class="token punctuation">,</span> <span class="token keyword">bool</span> im<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xmax <span class="token operator">=</span> _xmax<span class="token punctuation">;</span>
        res <span class="token operator">=</span> _res<span class="token punctuation">;</span>
        dt <span class="token operator">=</span> _dt<span class="token punctuation">;</span>
        timesteps <span class="token operator">=</span> _timesteps<span class="token punctuation">;</span>
        dx <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">;</span>
        x<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dk <span class="token operator">=</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        k<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        im_time <span class="token operator">=</span> im<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>xmax <span class="token operator">/</span> res <span class="token operator">-</span> xmax <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                k<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                k<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> res<span class="token punctuation">)</span> <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> xmax<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dt<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timesteps<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dx<span class="token punctuation">;</span>
    vector_real x<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dk<span class="token punctuation">;</span>
    vector_real k<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> im_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="code-method-sample" data-lang="py" data-name="Python"><pre class="language-"><code class="lang-python"><span class="token keyword">class</span> <span class="token class-name">Param</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Container for holding all simulation parameters.&quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 xmax<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 res<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 dt<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 timesteps<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 im_time<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>xmax <span class="token operator">=</span> xmax
        self<span class="token punctuation">.</span>res <span class="token operator">=</span> res
        self<span class="token punctuation">.</span>dt <span class="token operator">=</span> dt
        self<span class="token punctuation">.</span>timesteps <span class="token operator">=</span> timesteps
        self<span class="token punctuation">.</span>im_time <span class="token operator">=</span> im_time

        self<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span>xmax <span class="token operator">+</span> xmax <span class="token operator">/</span> res<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dx<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dk <span class="token operator">=</span> pi <span class="token operator">/</span> xmax
        self<span class="token punctuation">.</span>k <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span>res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>dk
</code></pre>
</div><div class="code-method-sample" data-lang="hs" data-name="Haskell"><pre class="language-"><code class="lang-haskell"><span class="token keyword">data</span> <span class="token constant">Parameters</span> <span class="token operator">=</span> <span class="token constant">Parameters</span>
  <span class="token punctuation">{</span> <span class="token hvariable">xmax</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">res</span> <span class="token operator">::</span> <span class="token constant">Int</span>
  <span class="token punctuation">,</span> <span class="token hvariable">dt</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">timesteps</span> <span class="token operator">::</span> <span class="token constant">Int</span>
  <span class="token punctuation">,</span> <span class="token hvariable">dx</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">x</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">dk</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">ks</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">imTime</span> <span class="token operator">::</span> <span class="token constant">Bool</span>
  <span class="token punctuation">}</span>

<span class="token hvariable">defaultParameters</span> <span class="token operator">::</span> <span class="token constant">Parameters</span>
<span class="token hvariable">defaultParameters</span> <span class="token operator">=</span> <span class="token hvariable">makeParameters</span> <span class="token number">10</span> <span class="token number">512</span> <span class="token number">0.01</span> <span class="token number">1000</span> <span class="token constant">True</span>

<span class="token hvariable">makeParameters</span> <span class="token operator">::</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">Bool</span> <span class="token operator">-&gt;</span> <span class="token constant">Parameters</span>
<span class="token hvariable">makeParameters</span> <span class="token hvariable">xmax</span> <span class="token hvariable">res</span> <span class="token hvariable">dt</span> <span class="token hvariable">timesteps</span> <span class="token hvariable">imTime</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token hvariable">fi</span> <span class="token operator">=</span> <span class="token builtin">fromIntegral</span>
      <span class="token hvariable">rng</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">res</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token hvariable">ks</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token operator">..</span> <span class="token builtin">div</span> <span class="token hvariable">res</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">++</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token builtin">div</span> <span class="token hvariable">res</span> <span class="token number">2</span> <span class="token operator">..</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
   <span class="token keyword">in</span> <span class="token constant">Parameters</span>
        <span class="token hvariable">xmax</span>
        <span class="token hvariable">res</span>
        <span class="token hvariable">dt</span>
        <span class="token hvariable">timesteps</span>
        <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token hvariable">xmax</span> <span class="token operator">/</span> <span class="token hvariable">fi</span> <span class="token hvariable">res</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token hvariable">listArray</span> <span class="token hvariable">rng</span> <span class="token operator">$</span>
         <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">n</span> <span class="token operator">-&gt;</span> <span class="token hvariable">xmax</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token hvariable">fi</span> <span class="token hvariable">n</span> <span class="token operator">/</span> <span class="token hvariable">fi</span> <span class="token hvariable">res</span><span class="token punctuation">)</span> <span class="token operator">:+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">..</span> <span class="token hvariable">res</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token builtin">pi</span> <span class="token operator">/</span> <span class="token hvariable">xmax</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token hvariable">listArray</span> <span class="token hvariable">rng</span> <span class="token operator">$</span> <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">:+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token builtin">pi</span> <span class="token operator">/</span> <span class="token hvariable">xmax</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">fi</span><span class="token punctuation">)</span> <span class="token hvariable">ks</span><span class="token punctuation">)</span>
        <span class="token hvariable">imTime</span>
</code></pre>
</div><div class="code-method-sample" data-lang="rs" data-name="Rust"><pre class="language-"><code class="lang-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Parameters</span> <span class="token punctuation">{</span>
    xmax<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    res<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    dt<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    timesteps<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    dx<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    x<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    dk<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    k<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    im_time<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Parameters</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>xmax<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> dt<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> timesteps<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> im_time<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Parameters</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> dx <span class="token operator">=</span> <span class="token number">2.0_f64</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> <span class="token punctuation">(</span>res <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> x<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> dk <span class="token operator">=</span> <span class="token constant">PI</span> <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> k<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>res <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>xmax <span class="token operator">/</span> <span class="token punctuation">(</span>res <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">-</span> xmax <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">*</span> dx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> i <span class="token punctuation">{</span>
                i <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI</span> <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>res <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI</span> <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Parameters</span> <span class="token punctuation">{</span>
            xmax<span class="token punctuation">,</span>
            res<span class="token punctuation">,</span>
            dt<span class="token punctuation">,</span>
            timesteps<span class="token punctuation">,</span>
            im_time<span class="token punctuation">,</span>
            dx<span class="token punctuation">,</span>
            x<span class="token punctuation">,</span>
            dk<span class="token punctuation">,</span>
            k<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div></div></div>

<p>As a note, when we generate our grid in momentum space <code>k</code>, we need to split the grid into two lines, one that is going from <code>0</code> to <code>-kmax</code> and is then discontinuous and goes from <code>kmax</code> to <code>0</code>.
This is simply because the FFT will naturally assume that the <code>0</code> in our grid is at the left side of the simulation, so we shift k-space to match this expectation.
Also, for this code we will be using notation to what we used above: <code>opr.R</code> will be the real space operators and <code>opr.K</code> will be the momentum space operators.
There is another Boolean value here called <code>im_time</code>, which is for imaginary time evolution.</p>
<p>Afterwards, we turn them into operators:</p>
<div class="code-method"><div class="code-method-definition"></div><div class="code-method-code"><div class="code-method-sample" data-lang="jl" data-name="Julia"><pre class="language-"><code class="lang-julia">mutable <span class="token keyword">struct</span> Operators
    V<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>
    R<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>
    K<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>
    wfc<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>

    Operators<span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=</span> new<span class="token punctuation">(</span>zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment"># Function to initialize the wfc and potential</span>
<span class="token keyword">function</span> init<span class="token punctuation">(</span>par<span class="token punctuation">::</span>Param<span class="token punctuation">,</span> voffset<span class="token punctuation">::</span>Float64<span class="token punctuation">,</span> wfcoffset<span class="token punctuation">::</span>Float64<span class="token punctuation">)</span>
    opr <span class="token operator">=</span> Operators<span class="token punctuation">(</span>length<span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    opr<span class="token punctuation">.</span>V <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token punctuation">.</span><span class="token operator">-</span> voffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span>
    opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token punctuation">.</span><span class="token operator">-</span> wfcoffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>par<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>opr<span class="token punctuation">.</span>V<span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">im</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">*</span>par<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">im</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">*</span>opr<span class="token punctuation">.</span>V<span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> opr
<span class="token keyword">end</span>
</code></pre>
</div><div class="code-method-sample" data-lang="c" data-name="C"><pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">operators</span> <span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>v<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>pe<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>ke<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>wfc<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-"><code class="lang-c"><span class="token keyword">void</span> <span class="token function">init_operators</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">operators</span> <span class="token operator">*</span>opr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">,</span> <span class="token keyword">double</span> voffset<span class="token punctuation">,</span>
                    <span class="token keyword">double</span> wfcoffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    opr<span class="token operator">-&gt;</span>size <span class="token operator">=</span> par<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>v <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>pe <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>ke <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>wfc <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> par<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        opr<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> voffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opr<span class="token operator">-&gt;</span>wfc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> wfcoffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token operator">-&gt;</span>ke<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            opr<span class="token operator">-&gt;</span>pe<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> opr<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            opr<span class="token operator">-&gt;</span>ke<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> I<span class="token punctuation">)</span><span class="token punctuation">;</span>
            opr<span class="token operator">-&gt;</span>pe<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> opr<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> I<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="code-method-sample" data-lang="cpp" data-name="C++"><pre class="language-"><code class="lang-cpp"><span class="token keyword">struct</span> <span class="token class-name">Operators</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Operators</span><span class="token punctuation">(</span>Params <span class="token operator">&amp;</span>par<span class="token punctuation">,</span> <span class="token keyword">double</span> voffset<span class="token punctuation">,</span>
              <span class="token keyword">double</span> wfcoffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size <span class="token operator">=</span> par<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
        v<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pe<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ke<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wfc<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> voffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wfc<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> wfcoffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    size_t size<span class="token punctuation">;</span>
    vector_complex v<span class="token punctuation">;</span>
    vector_complex pe<span class="token punctuation">;</span>
    vector_complex ke<span class="token punctuation">;</span>
    vector_complex wfc<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
</div><div class="code-method-sample" data-lang="py" data-name="Python"><pre class="language-"><code class="lang-python"><span class="token keyword">class</span> <span class="token class-name">Operators</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Container for holding operators and wavefunction coefficients.&quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>V <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>R <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>K <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> Param<span class="token punctuation">,</span> voffset<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> wfcoffset<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Operators<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Initialize the wavefunction coefficients and the potential.&quot;&quot;&quot;</span>
    opr <span class="token operator">=</span> Operators<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    opr<span class="token punctuation">.</span>V <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token operator">-</span> voffset<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
    opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token operator">-</span> wfcoffset<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time<span class="token punctuation">:</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>k <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>V <span class="token operator">*</span> par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>k <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token number">1j</span><span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>V <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token number">1j</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> opr
</code></pre>
</div><div class="code-method-sample" data-lang="hs" data-name="Haskell"><pre class="language-"><code class="lang-haskell"><span class="token keyword">data</span> <span class="token constant">Operators</span> <span class="token operator">=</span> <span class="token constant">Operators</span>
  <span class="token punctuation">{</span> <span class="token hvariable">v</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">rStep</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">kStep</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">wfc</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">}</span>

<span class="token hvariable">makeOperators</span> <span class="token operator">::</span> <span class="token constant">Parameters</span> <span class="token operator">-&gt;</span> <span class="token constant">Complex</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Complex</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Operators</span>
<span class="token hvariable">makeOperators</span> <span class="token hvariable">param</span> <span class="token hvariable">v0</span> <span class="token hvariable">wfc0</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token hvariable">rng</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">res</span> <span class="token hvariable">param</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token hvariable">time</span>
        <span class="token operator">|</span> <span class="token hvariable">imTime</span> <span class="token hvariable">param</span> <span class="token operator">=</span> <span class="token hvariable">dt</span> <span class="token hvariable">param</span> <span class="token operator">:+</span> <span class="token number">0</span>
        <span class="token operator">|</span> <span class="token builtin">otherwise</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">:+</span> <span class="token hvariable">dt</span> <span class="token hvariable">param</span>
      <span class="token hvariable">v</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token operator">-</span> <span class="token hvariable">v0</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
      <span class="token hvariable">rStep</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token hvariable">time</span> <span class="token operator">*</span> <span class="token hvariable">x</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token hvariable">v</span>
      <span class="token hvariable">kStep</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">k</span> <span class="token operator">-&gt;</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token hvariable">time</span> <span class="token operator">*</span> <span class="token hvariable">k</span> <span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">ks</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
      <span class="token hvariable">wfc</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token operator">-</span> <span class="token hvariable">wfc0</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
   <span class="token keyword">in</span> <span class="token constant">Operators</span> <span class="token hvariable">v</span> <span class="token hvariable">rStep</span> <span class="token hvariable">kStep</span> <span class="token punctuation">(</span><span class="token hvariable">normalize</span> <span class="token punctuation">(</span><span class="token hvariable">dx</span> <span class="token hvariable">param</span><span class="token punctuation">)</span> <span class="token hvariable">wfc</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="code-method-sample" data-lang="rs" data-name="Rust"><pre class="language-"><code class="lang-rust"><span class="token keyword">struct</span> <span class="token type-definition class-name">Operators</span> <span class="token punctuation">{</span>
    v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    pe<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    ke<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    wfc<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Operators</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Parameters</span><span class="token punctuation">,</span> v_offset<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> wfc_offset<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Operators</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pe<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> ke<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> wfc<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                <span class="token number">0.5_f64</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> v_offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wfc<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> wfc_offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                    <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Operators</span> <span class="token punctuation">{</span> v<span class="token punctuation">,</span> pe<span class="token punctuation">,</span> ke<span class="token punctuation">,</span> wfc <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div></div></div>

<p>Here, we use a standard harmonic potential for the atoms to sit in and a Gaussian distribution for an initial guess for the probability distribution.
If we give either the trap or the atoms a slight offset (so the Gaussian distribution of atoms does not <em>quite</em> rest at the bottom of the <script type="math/tex; ">x^2</script> potential, we can see the atoms moving back and forth in the potential as we move the simulation forward in time.
This means that we can easily see the dynamics of our quantum system!
If we run the simulation in imaginary time, we will see the Gaussian distribution of atoms move towards the center of the potential, which is the location with the lowest energy.
Both of these have been shown in the figures above.</p>
<p>The final step is to do the iteration, itself.</p>
<div class="code-method"><div class="code-method-definition"></div><div class="code-method-code"><div class="code-method-sample" data-lang="jl" data-name="Julia"><pre class="language-"><code class="lang-julia"><span class="token keyword">function</span> split_op<span class="token operator">!</span><span class="token punctuation">(</span>par<span class="token punctuation">::</span>Param<span class="token punctuation">,</span> opr<span class="token punctuation">::</span>Operators<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>par<span class="token punctuation">.</span>timesteps
        <span class="token comment"># Half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc <span class="token punctuation">.</span><span class="token operator">*</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># fft to momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> fft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># Full step in momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc <span class="token punctuation">.</span><span class="token operator">*</span> opr<span class="token punctuation">.</span>K

        <span class="token comment"># ifft back</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> ifft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># final half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc <span class="token punctuation">.</span><span class="token operator">*</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># density for plotting and potential</span>
        density <span class="token operator">=</span> abs2<span class="token punctuation">.</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># renormalizing for imaginary time</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span>
            renorm_factor <span class="token operator">=</span> sum<span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dx

            <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>length<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> sqrt<span class="token punctuation">(</span>renorm_factor<span class="token punctuation">)</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment"># Outputting data to file. Plotting can also be done in a similar way</span>
        <span class="token comment"># This is set to output exactly 100 files, no matter how many timesteps</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> div<span class="token punctuation">(</span>par<span class="token punctuation">.</span>timesteps<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            outfile <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">&quot;output&quot;</span> <span class="token operator">*</span> string<span class="token punctuation">(</span>lpad<span class="token punctuation">(</span>string<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> string<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token operator">*</span> <span class="token string">&quot;.dat&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span>

            <span class="token comment"># Outputting for gnuplot. Any plotter will do.</span>
            <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>length<span class="token punctuation">(</span>density<span class="token punctuation">)</span>
                write<span class="token punctuation">(</span>outfile<span class="token punctuation">,</span> string<span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">&quot;\t&quot;</span>
                               <span class="token operator">*</span> string<span class="token punctuation">(</span>density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">&quot;\t&quot;</span>
                               <span class="token operator">*</span> string<span class="token punctuation">(</span>real<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>V<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>

            close<span class="token punctuation">(</span>outfile<span class="token punctuation">)</span>
            <span class="token keyword">println</span><span class="token punctuation">(</span><span class="token string">&quot;Outputting step: &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre>
</div><div class="code-method-sample" data-lang="c" data-name="C"><pre class="language-"><code class="lang-c"><span class="token keyword">void</span> <span class="token function">split_op</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">operators</span> opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> density<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> par<span class="token punctuation">.</span>timesteps<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>ke<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            density<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">cabs</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sum <span class="token operator">+=</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sum <span class="token operator">*=</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Writing data into a file in the format of:</span>
        <span class="token comment">// index, density, real potential.</span>
        <span class="token keyword">char</span> filename<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;output%lu.dat&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">&quot;%d\t%f\t%f\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> density<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">creal</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="code-method-sample" data-lang="cpp" data-name="C++"><pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token function">split_op</span><span class="token punctuation">(</span>Params <span class="token operator">&amp;</span>par<span class="token punctuation">,</span> Operators <span class="token operator">&amp;</span>opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> density<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> par<span class="token punctuation">.</span>timesteps<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>ke<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            density<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sum <span class="token operator">+=</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sum <span class="token operator">*=</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Writing data into a file in the format of:</span>
        <span class="token comment">// index, density, real potential.</span>
        std<span class="token double-colon punctuation">::</span>stringstream filename_stream<span class="token punctuation">;</span>
        filename_stream <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;output&quot;</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;.dat&quot;</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>ofstream fstream <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">ofstream</span><span class="token punctuation">(</span>filename_stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fstream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>stringstream data_stream<span class="token punctuation">;</span>

                data_stream <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">&lt;&lt;</span> density<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token function">real</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>

                fstream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data_stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        fstream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="code-method-sample" data-lang="py" data-name="Python"><pre class="language-"><code class="lang-python"><span class="token keyword">def</span> <span class="token function">split_op</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> Param<span class="token punctuation">,</span> opr<span class="token punctuation">:</span> Operators<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>timesteps<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># Half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">*=</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># FFT to momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># Full step in momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">*=</span> opr<span class="token punctuation">.</span>K

        <span class="token comment"># iFFT back</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>ifft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># Final half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">*=</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># Density for plotting and potential</span>
        density <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>

        <span class="token comment"># Renormalizing for imaginary time</span>
        <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time<span class="token punctuation">:</span>
            renorm_factor <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dx
            opr<span class="token punctuation">.</span>wfc <span class="token operator">/=</span> sqrt<span class="token punctuation">(</span>renorm_factor<span class="token punctuation">)</span>

        <span class="token comment"># Outputting data to file. Plotting can also be done in a</span>
        <span class="token comment"># similar way. This is set to output exactly 100 files, no</span>
        <span class="token comment"># matter how many timesteps were specified.</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>timesteps <span class="token operator">//</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            filename <span class="token operator">=</span> <span class="token string">&quot;output{}.dat&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> outfile<span class="token punctuation">:</span>
                <span class="token comment"># Outputting for gnuplot. Any plotter will do.</span>
                <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    template <span class="token operator">=</span> <span class="token string">&quot;{}\t{}\t{}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span>
                    line <span class="token operator">=</span> template<span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>V<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">)</span>
                    outfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Outputting step: &quot;</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="code-method-sample" data-lang="hs" data-name="Haskell"><pre class="language-"><code class="lang-haskell"><span class="token hvariable">evolve</span> <span class="token operator">::</span> <span class="token constant">Parameters</span> <span class="token operator">-&gt;</span> <span class="token constant">Operators</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token constant">Operators</span><span class="token punctuation">]</span>
<span class="token hvariable">evolve</span> <span class="token hvariable">param</span> <span class="token hvariable">op</span><span class="token operator">@</span><span class="token punctuation">(</span><span class="token constant">Operators</span> <span class="token hvariable">_</span> <span class="token hvariable">rStep</span> <span class="token hvariable">kStep</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">iterate</span> <span class="token hvariable">splitop</span> <span class="token hvariable">op</span>
  <span class="token keyword">where</span>
    <span class="token hvariable">splitop</span> <span class="token hvariable">op</span> <span class="token operator">=</span> <span class="token hvariable">op</span> <span class="token punctuation">{</span><span class="token hvariable">wfc</span> <span class="token operator">=</span> <span class="token hvariable">wfc&apos;</span> <span class="token hvariable">op</span><span class="token punctuation">}</span>
    <span class="token hvariable">wfc&apos;</span> <span class="token operator">=</span> <span class="token hvariable">norm</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">rStep</span> <span class="token operator">.*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">idft</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">kStep</span> <span class="token operator">.*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">dft</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">rStep</span> <span class="token operator">.*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">wfc</span>
    <span class="token hvariable">norm</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token hvariable">imTime</span> <span class="token hvariable">param</span> <span class="token keyword">then</span> <span class="token hvariable">normalize</span> <span class="token punctuation">(</span><span class="token hvariable">dx</span> <span class="token hvariable">param</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">id</span>
</code></pre>
</div><div class="code-method-sample" data-lang="rs" data-name="Rust"><pre class="language-"><code class="lang-rust"><span class="token keyword">fn</span> <span class="token function-definition function">split_op</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Parameters</span><span class="token punctuation">,</span> opr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Operators</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> density<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>timesteps <span class="token punctuation">{</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>ke<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        density <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x<span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time <span class="token punctuation">{</span>
            <span class="token keyword">let</span> sum <span class="token operator">=</span> density<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>

            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> sum<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Writing data into a file in the format of:</span>
        <span class="token comment">// index, density, real potential.</span>
        <span class="token keyword">let</span> path_name <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;output{}.dat&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> display <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&apos;t create {}: {}&quot;</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span> why<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>good<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> good<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token macro property">writeln!</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;{}\t{}\t{}&quot;</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&apos;t write to {}: {}&quot;</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span> why<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span> <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&apos;t flush {}: {}&quot;</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span> why<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</div></div></div>

<p>And that&apos;s it.</p>
<p>There is something a bit odd about the simulation in imaginary time, though.
Basically, in imaginary time, we see an exponential decay of all the higher energy states, which means we are technically losing a large amount of our wavefunction density every timestep!
To solve this issue, we <em>renormalize</em> by enforcing that <script type="math/tex; ">\int_{-\infty}^{+\infty}\Psi^\ast\Psi dx = 1</script>.
As you can see from the code, this involves summing the density, multiplying that sum by <code>dx</code>, and then dividing each element in the wavefunction by the <code>sqrt()</code> of that value.</p>
<p>The Split-Operator method is one of the most commonly used quantum simulation algorithms because of how straightforward it is to code and how quickly you can start really digging into the physics of the simulation results!</p>
<h2 id="video-explanation">Video Explanation</h2>
<p>Here is a video describing the split-operator method:</p>
<div style="text-align:center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/BBt8EugN03Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

<h2 id="example-code">Example Code</h2>
<p>This example code is a simulation of a Gaussian distribution of atoms slightly offset in a harmonic trap in imaginary time.
So long as the code is written appropriately, this means that the atoms should move towards the center of the trap and the energy should decay to <script type="math/tex; ">\frac{1}{2}\hbar\omega</script>, which will be simply <script type="math/tex; ">\frac{1}{2}</script> in this simulation.
Checking to make sure your code can output the correct energy for a harmonic trap is a good test to make sure it is all working under-the-hood before simulating systems with more complicated Hamiltonians.</p>
<div class="code-method"><div class="code-method-definition"></div><div class="code-method-code"><div class="code-method-sample" data-lang="jl" data-name="Julia"><pre class="language-"><code class="lang-julia"><span class="token comment">#------------split_op.jl-------------------------------------------------------#</span>
<span class="token comment">#</span>
<span class="token comment"># Plotting: to plot individual timesteps, use gnuplot like so:</span>
<span class="token comment">#               p &quot;output00000.dat&quot; u 1:2 w l</span>
<span class="token comment">#               rep &quot;output00000.dat&quot; u 1:3 w l</span>
<span class="token comment">#</span>
<span class="token comment">#------------------------------------------------------------------------------#</span>

<span class="token keyword">using</span> FFTW

<span class="token keyword">struct</span> Param
    xmax<span class="token punctuation">::</span>Float64
    res<span class="token punctuation">::</span>Int64
    dt<span class="token punctuation">::</span>Float64
    timesteps<span class="token punctuation">::</span>Int64
    dx<span class="token punctuation">::</span>Float64
    x<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span>
    dk<span class="token punctuation">::</span>Float64
    k<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span>
    im_time<span class="token punctuation">::</span>Bool

    Param<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> new<span class="token punctuation">(</span><span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">10.0</span><span class="token operator">/</span><span class="token number">512</span><span class="token punctuation">,</span>
                  Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10.0</span> <span class="token operator">+</span> <span class="token number">10.0</span><span class="token operator">/</span><span class="token number">512</span> <span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token operator">/</span><span class="token number">512</span> <span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token constant">pi</span> <span class="token operator">/</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
                  Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span>vcat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">512</span><span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">pi</span><span class="token operator">/</span><span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  <span class="token boolean">false</span><span class="token punctuation">)</span>
    Param<span class="token punctuation">(</span>xmax<span class="token punctuation">::</span>Float64<span class="token punctuation">,</span> res<span class="token punctuation">::</span>Int64<span class="token punctuation">,</span> dt<span class="token punctuation">::</span>Float64<span class="token punctuation">,</span> timesteps<span class="token punctuation">::</span>Int64<span class="token punctuation">,</span>
          im_val<span class="token punctuation">::</span>Bool<span class="token punctuation">)</span> <span class="token operator">=</span> new<span class="token punctuation">(</span>
              xmax<span class="token punctuation">,</span> res<span class="token punctuation">,</span> dt<span class="token punctuation">,</span> timesteps<span class="token punctuation">,</span>
              <span class="token number">2</span><span class="token operator">*</span>xmax<span class="token operator">/</span>res<span class="token punctuation">,</span> Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token operator">-</span>xmax<span class="token operator">+</span>xmax<span class="token operator">/</span>res<span class="token punctuation">:</span><span class="token number">2</span><span class="token operator">*</span>xmax<span class="token operator">/</span>res<span class="token punctuation">:</span>xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token constant">pi</span><span class="token operator">/</span>xmax<span class="token punctuation">,</span> Vector<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">(</span>vcat<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">:</span>res<span class="token operator">/</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span>res<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token constant">pi</span><span class="token operator">/</span><span class="token punctuation">(</span>xmax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              im_val
          <span class="token punctuation">)</span>
<span class="token keyword">end</span>

mutable <span class="token keyword">struct</span> Operators
    V<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>
    R<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>
    K<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>
    wfc<span class="token punctuation">::</span>Vector<span class="token punctuation">{</span>Complex<span class="token punctuation">{</span>Float64<span class="token punctuation">}</span><span class="token punctuation">}</span>

    Operators<span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=</span> new<span class="token punctuation">(</span>zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         zeros<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token comment"># Function to initialize the wfc and potential</span>
<span class="token keyword">function</span> init<span class="token punctuation">(</span>par<span class="token punctuation">::</span>Param<span class="token punctuation">,</span> voffset<span class="token punctuation">::</span>Float64<span class="token punctuation">,</span> wfcoffset<span class="token punctuation">::</span>Float64<span class="token punctuation">)</span>
    opr <span class="token operator">=</span> Operators<span class="token punctuation">(</span>length<span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    opr<span class="token punctuation">.</span>V <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token punctuation">.</span><span class="token operator">-</span> voffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span>
    opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token punctuation">.</span><span class="token operator">-</span> wfcoffset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>par<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token operator">*</span>opr<span class="token punctuation">.</span>V<span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">im</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">*</span>par<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token constant">im</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token operator">*</span>opr<span class="token punctuation">.</span>V<span class="token operator">*</span>par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> opr
<span class="token keyword">end</span>

<span class="token comment"># Function for the split-operator loop</span>
<span class="token keyword">function</span> split_op<span class="token operator">!</span><span class="token punctuation">(</span>par<span class="token punctuation">::</span>Param<span class="token punctuation">,</span> opr<span class="token punctuation">::</span>Operators<span class="token punctuation">)</span>

    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>par<span class="token punctuation">.</span>timesteps
        <span class="token comment"># Half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc <span class="token punctuation">.</span><span class="token operator">*</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># fft to momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> fft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># Full step in momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc <span class="token punctuation">.</span><span class="token operator">*</span> opr<span class="token punctuation">.</span>K

        <span class="token comment"># ifft back</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> ifft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># final half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc <span class="token punctuation">.</span><span class="token operator">*</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># density for plotting and potential</span>
        density <span class="token operator">=</span> abs2<span class="token punctuation">.</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># renormalizing for imaginary time</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span>
            renorm_factor <span class="token operator">=</span> sum<span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dx

            <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>length<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> sqrt<span class="token punctuation">(</span>renorm_factor<span class="token punctuation">)</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>

        <span class="token comment"># Outputting data to file. Plotting can also be done in a similar way</span>
        <span class="token comment"># This is set to output exactly 100 files, no matter how many timesteps</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> div<span class="token punctuation">(</span>par<span class="token punctuation">.</span>timesteps<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            outfile <span class="token operator">=</span> open<span class="token punctuation">(</span><span class="token string">&quot;output&quot;</span> <span class="token operator">*</span> string<span class="token punctuation">(</span>lpad<span class="token punctuation">(</span>string<span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> string<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token operator">*</span> <span class="token string">&quot;.dat&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span>

            <span class="token comment"># Outputting for gnuplot. Any plotter will do.</span>
            <span class="token keyword">for</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>length<span class="token punctuation">(</span>density<span class="token punctuation">)</span>
                write<span class="token punctuation">(</span>outfile<span class="token punctuation">,</span> string<span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">&quot;\t&quot;</span>
                               <span class="token operator">*</span> string<span class="token punctuation">(</span>density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">&quot;\t&quot;</span>
                               <span class="token operator">*</span> string<span class="token punctuation">(</span>real<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>V<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">end</span>

            close<span class="token punctuation">(</span>outfile<span class="token punctuation">)</span>
            <span class="token keyword">println</span><span class="token punctuation">(</span><span class="token string">&quot;Outputting step: &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment"># We are calculating the energy to check &lt;Psi|H|Psi&gt;</span>
<span class="token keyword">function</span> calculate_energy<span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span>
    <span class="token comment"># Creating real, momentum, and conjugate wavefunctions</span>
    wfc_r <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc
    wfc_k <span class="token operator">=</span> fft<span class="token punctuation">(</span>wfc_r<span class="token punctuation">)</span>
    wfc_c <span class="token operator">=</span> conj<span class="token punctuation">(</span>wfc_r<span class="token punctuation">)</span>

    <span class="token comment"># Finding the momentum and real-space energy terms</span>
    energy_k <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span>wfc_c<span class="token punctuation">.</span><span class="token operator">*</span>ifft<span class="token punctuation">(</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">.</span><span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token operator">*</span> wfc_k<span class="token punctuation">)</span>
    energy_r <span class="token operator">=</span> wfc_c<span class="token punctuation">.</span><span class="token operator">*</span>opr<span class="token punctuation">.</span>V <span class="token punctuation">.</span><span class="token operator">*</span> wfc_r

    <span class="token comment"># Integrating over all space</span>
    energy_final <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">:</span>length<span class="token punctuation">(</span>energy_k<span class="token punctuation">)</span>
        energy_final <span class="token operator">+=</span> real<span class="token punctuation">(</span>energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> energy_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    <span class="token keyword">return</span> energy_final<span class="token operator">*</span>par<span class="token punctuation">.</span>dx
<span class="token keyword">end</span>

<span class="token comment"># main function</span>
<span class="token keyword">function</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span>
    par <span class="token operator">=</span> Param<span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token comment"># Starting wavefunction slightly offset so we can see it change</span>
    opr <span class="token operator">=</span> init<span class="token punctuation">(</span>par<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.00</span><span class="token punctuation">)</span>
    split_op<span class="token operator">!</span><span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span>

    energy <span class="token operator">=</span> calculate_energy<span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span>
    <span class="token keyword">println</span><span class="token punctuation">(</span><span class="token string">&quot;Energy is: &quot;</span><span class="token punctuation">,</span> energy<span class="token punctuation">)</span>
<span class="token keyword">end</span>

main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="code-method-sample" data-lang="c" data-name="C"><pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;complex.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdbool.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;math.h&gt;</span></span>

<span class="token comment">// Using fftw3 library.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fftw3.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">params</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> xmax<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dt<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timesteps<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dx<span class="token punctuation">;</span>
    <span class="token keyword">double</span> <span class="token operator">*</span>x<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dk<span class="token punctuation">;</span>
    <span class="token keyword">double</span> <span class="token operator">*</span>k<span class="token punctuation">;</span>
    bool im_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">operators</span> <span class="token punctuation">{</span>
    <span class="token class-name">size_t</span> size<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>v<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>pe<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>ke<span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex <span class="token operator">*</span>wfc<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">fft</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex <span class="token operator">*</span>x<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> bool inverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> complex y<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fftw_plan p<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>inverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p <span class="token operator">=</span> <span class="token function">fftw_plan_dft_1d</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token punctuation">(</span>fftw_complex<span class="token operator">*</span><span class="token punctuation">)</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>fftw_complex<span class="token operator">*</span><span class="token punctuation">)</span>y<span class="token punctuation">,</span>
                             FFTW_BACKWARD<span class="token punctuation">,</span> FFTW_ESTIMATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        p <span class="token operator">=</span> <span class="token function">fftw_plan_dft_1d</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token punctuation">(</span>fftw_complex<span class="token operator">*</span><span class="token punctuation">)</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>fftw_complex<span class="token operator">*</span><span class="token punctuation">)</span>y<span class="token punctuation">,</span>
                             FFTW_FORWARD<span class="token punctuation">,</span> FFTW_ESTIMATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fftw_execute</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fftw_destroy_plan</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">init_params</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">params</span> <span class="token operator">*</span>par<span class="token punctuation">,</span> <span class="token keyword">double</span> xmax<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> res<span class="token punctuation">,</span> <span class="token keyword">double</span> dt<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timesteps<span class="token punctuation">,</span> bool im<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    par<span class="token operator">-&gt;</span>xmax <span class="token operator">=</span> xmax<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>dt <span class="token operator">=</span> dt<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>timesteps <span class="token operator">=</span> timesteps<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>dx <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>x <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token operator">*</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>dk <span class="token operator">=</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>k <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token operator">*</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    par<span class="token operator">-&gt;</span>im_time <span class="token operator">=</span> im<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        par<span class="token operator">-&gt;</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> xmax <span class="token operator">/</span> res <span class="token operator">-</span> xmax <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            par<span class="token operator">-&gt;</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            par<span class="token operator">-&gt;</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>i <span class="token operator">-</span> res<span class="token punctuation">)</span> <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">init_operators</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">operators</span> <span class="token operator">*</span>opr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">,</span> <span class="token keyword">double</span> voffset<span class="token punctuation">,</span>
                    <span class="token keyword">double</span> wfcoffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    opr<span class="token operator">-&gt;</span>size <span class="token operator">=</span> par<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>v <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>pe <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>ke <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    opr<span class="token operator">-&gt;</span>wfc <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">double</span> complex<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> par<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        opr<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> voffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opr<span class="token operator">-&gt;</span>wfc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> wfcoffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token operator">-&gt;</span>ke<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            opr<span class="token operator">-&gt;</span>pe<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> opr<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            opr<span class="token operator">-&gt;</span>ke<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> I<span class="token punctuation">)</span><span class="token punctuation">;</span>
            opr<span class="token operator">-&gt;</span>pe<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cexp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> opr<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> I<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">split_op</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">operators</span> opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> density<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> par<span class="token punctuation">.</span>timesteps<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>ke<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            density<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">cabs</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sum <span class="token operator">+=</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sum <span class="token operator">*=</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Writing data into a file in the format of:</span>
        <span class="token comment">// index, density, real potential.</span>
        <span class="token keyword">char</span> filename<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;output%lu.dat&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        FILE <span class="token operator">*</span>fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token string">&quot;%d\t%f\t%f\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> density<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">creal</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">calculate_energy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">operators</span> opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> complex wfc_r<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex wfc_k<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex wfc_c<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>wfc_r<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>wfc_r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>wfc_k<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>wfc_k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fft</span><span class="token punctuation">(</span>wfc_k<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">conj</span><span class="token punctuation">(</span>wfc_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> complex energy_k<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> complex energy_r<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token function">cpow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.0</span><span class="token operator">*</span>I<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fft</span><span class="token punctuation">(</span>energy_k<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">0.5</span> <span class="token operator">*</span> wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        energy_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> wfc_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> energy_final <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        energy_final <span class="token operator">+=</span> <span class="token function">creal</span><span class="token punctuation">(</span>energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> energy_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> energy_final <span class="token operator">*</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">free_params</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">free_operators</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">operators</span> opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>pe<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>ke<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">params</span> par<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">operators</span> opr<span class="token punctuation">;</span>

    <span class="token function">init_params</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>par<span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init_operators</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opr<span class="token punctuation">,</span> par<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">split_op</span><span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;the energy is %f\n&quot;</span><span class="token punctuation">,</span> <span class="token function">calculate_energy</span><span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">free_params</span><span class="token punctuation">(</span>par<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">free_operators</span><span class="token punctuation">(</span>opr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="code-method-sample" data-lang="cpp" data-name="C++"><pre class="language-"><code class="lang-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;complex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>

<span class="token comment">// Using fftw3 library.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fftw3.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">M_PI</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M_PI</span> <span class="token expression"><span class="token number">3.14159265358979323846</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">using</span> complex <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> vector_real <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> vector_complex <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>complex<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Params</span> <span class="token punctuation">{</span>
    <span class="token function">Params</span><span class="token punctuation">(</span><span class="token keyword">double</span> _xmax<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> _res<span class="token punctuation">,</span> <span class="token keyword">double</span> _dt<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> _timesteps<span class="token punctuation">,</span> <span class="token keyword">bool</span> im<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xmax <span class="token operator">=</span> _xmax<span class="token punctuation">;</span>
        res <span class="token operator">=</span> _res<span class="token punctuation">;</span>
        dt <span class="token operator">=</span> _dt<span class="token punctuation">;</span>
        timesteps <span class="token operator">=</span> _timesteps<span class="token punctuation">;</span>
        dx <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">;</span>
        x<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dk <span class="token operator">=</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        k<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        im_time <span class="token operator">=</span> im<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>xmax <span class="token operator">/</span> res <span class="token operator">-</span> xmax <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                k<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>i <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                k<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">-</span> res<span class="token punctuation">)</span> <span class="token operator">*</span> M_PI <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> xmax<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> res<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dt<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> timesteps<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dx<span class="token punctuation">;</span>
    vector_real x<span class="token punctuation">;</span>
    <span class="token keyword">double</span> dk<span class="token punctuation">;</span>
    vector_real k<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> im_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Operators</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Operators</span><span class="token punctuation">(</span>Params <span class="token operator">&amp;</span>par<span class="token punctuation">,</span> <span class="token keyword">double</span> voffset<span class="token punctuation">,</span>
              <span class="token keyword">double</span> wfcoffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        size <span class="token operator">=</span> par<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
        v<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pe<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ke<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wfc<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> voffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wfc<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> wfcoffset<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token function">complex</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    size_t size<span class="token punctuation">;</span>
    vector_complex v<span class="token punctuation">;</span>
    vector_complex pe<span class="token punctuation">;</span>
    vector_complex ke<span class="token punctuation">;</span>
    vector_complex wfc<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">fft</span><span class="token punctuation">(</span>vector_complex <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> <span class="token keyword">bool</span> inverse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>complex<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> <span class="token function">y</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">complex</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fftw_plan p<span class="token punctuation">;</span>

    fftw_complex <span class="token operator">*</span>in <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>fftw_complex<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fftw_complex <span class="token operator">*</span>out <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>fftw_complex<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>y<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p <span class="token operator">=</span> <span class="token function">fftw_plan_dft_1d</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span>
                         <span class="token punctuation">(</span>inverse <span class="token operator">?</span> FFTW_BACKWARD <span class="token operator">:</span> FFTW_FORWARD<span class="token punctuation">)</span><span class="token punctuation">,</span> FFTW_ESTIMATE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fftw_execute</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fftw_destroy_plan</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> x<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">split_op</span><span class="token punctuation">(</span>Params <span class="token operator">&amp;</span>par<span class="token punctuation">,</span> Operators <span class="token operator">&amp;</span>opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">double</span> density<span class="token punctuation">[</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> par<span class="token punctuation">.</span>timesteps<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>ke<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            density<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>im_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sum <span class="token operator">+=</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            sum <span class="token operator">*=</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Writing data into a file in the format of:</span>
        <span class="token comment">// index, density, real potential.</span>
        std<span class="token double-colon punctuation">::</span>stringstream filename_stream<span class="token punctuation">;</span>
        filename_stream <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;output&quot;</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;.dat&quot;</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>ofstream fstream <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">ofstream</span><span class="token punctuation">(</span>filename_stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fstream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                std<span class="token double-colon punctuation">::</span>stringstream data_stream<span class="token punctuation">;</span>

                data_stream <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">&lt;&lt;</span> density<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token function">real</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>

                fstream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data_stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data_stream<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        fstream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">calculate_energy</span><span class="token punctuation">(</span>Params <span class="token operator">&amp;</span>par<span class="token punctuation">,</span> Operators <span class="token operator">&amp;</span>opr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vector_complex <span class="token function">wfc_r</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector_complex <span class="token function">wfc_k</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector_complex <span class="token function">wfc_c</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fft</span><span class="token punctuation">(</span>wfc_k<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">conj</span><span class="token punctuation">(</span>wfc_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    vector_complex <span class="token function">energy_k</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector_complex <span class="token function">energy_r</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token function">complex</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fft</span><span class="token punctuation">(</span>energy_k<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">0.5</span> <span class="token operator">*</span> wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        energy_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> wfc_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">double</span> energy_final <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> opr<span class="token punctuation">.</span>size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        energy_final <span class="token operator">+=</span> <span class="token function">real</span><span class="token punctuation">(</span>energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> energy_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> energy_final <span class="token operator">*</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Params par <span class="token operator">=</span> <span class="token function">Params</span><span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Operators opr <span class="token operator">=</span> <span class="token function">Operators</span><span class="token punctuation">(</span>par<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">split_op</span><span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;The energy is &quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token function">calculate_energy</span><span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div><div class="code-method-sample" data-lang="py" data-name="Python"><pre class="language-"><code class="lang-python"><span class="token keyword">from</span> math <span class="token keyword">import</span> pi
<span class="token keyword">from</span> math <span class="token keyword">import</span> sqrt

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np


<span class="token keyword">class</span> <span class="token class-name">Param</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Container for holding all simulation parameters.&quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 xmax<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 res<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 dt<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
                 timesteps<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 im_time<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>xmax <span class="token operator">=</span> xmax
        self<span class="token punctuation">.</span>res <span class="token operator">=</span> res
        self<span class="token punctuation">.</span>dt <span class="token operator">=</span> dt
        self<span class="token punctuation">.</span>timesteps <span class="token operator">=</span> timesteps
        self<span class="token punctuation">.</span>im_time <span class="token operator">=</span> im_time

        self<span class="token punctuation">.</span>dx <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> res
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span>xmax <span class="token operator">+</span> xmax <span class="token operator">/</span> res<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dx<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dk <span class="token operator">=</span> pi <span class="token operator">/</span> xmax
        self<span class="token punctuation">.</span>k <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span>res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>dk


<span class="token keyword">class</span> <span class="token class-name">Operators</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Container for holding operators and wavefunction coefficients.&quot;&quot;&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>V <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>R <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>K <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>empty<span class="token punctuation">(</span>res<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> Param<span class="token punctuation">,</span> voffset<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span> wfcoffset<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Operators<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Initialize the wavefunction coefficients and the potential.&quot;&quot;&quot;</span>
    opr <span class="token operator">=</span> Operators<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    opr<span class="token punctuation">.</span>V <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token operator">-</span> voffset<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
    opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x <span class="token operator">-</span> wfcoffset<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token builtin">complex</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time<span class="token punctuation">:</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>k <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>V <span class="token operator">*</span> par<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        opr<span class="token punctuation">.</span>K <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>k <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token number">1j</span><span class="token punctuation">)</span>
        opr<span class="token punctuation">.</span>R <span class="token operator">=</span> np<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>V <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token number">1j</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> opr


<span class="token keyword">def</span> <span class="token function">split_op</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> Param<span class="token punctuation">,</span> opr<span class="token punctuation">:</span> Operators<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>timesteps<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token comment"># Half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">*=</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># FFT to momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># Full step in momentum space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">*=</span> opr<span class="token punctuation">.</span>K

        <span class="token comment"># iFFT back</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>ifft<span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span>

        <span class="token comment"># Final half-step in real space</span>
        opr<span class="token punctuation">.</span>wfc <span class="token operator">*=</span> opr<span class="token punctuation">.</span>R

        <span class="token comment"># Density for plotting and potential</span>
        density <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>opr<span class="token punctuation">.</span>wfc<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>

        <span class="token comment"># Renormalizing for imaginary time</span>
        <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time<span class="token punctuation">:</span>
            renorm_factor <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dx
            opr<span class="token punctuation">.</span>wfc <span class="token operator">/=</span> sqrt<span class="token punctuation">(</span>renorm_factor<span class="token punctuation">)</span>

        <span class="token comment"># Outputting data to file. Plotting can also be done in a</span>
        <span class="token comment"># similar way. This is set to output exactly 100 files, no</span>
        <span class="token comment"># matter how many timesteps were specified.</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>timesteps <span class="token operator">//</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            filename <span class="token operator">=</span> <span class="token string">&quot;output{}.dat&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> outfile<span class="token punctuation">:</span>
                <span class="token comment"># Outputting for gnuplot. Any plotter will do.</span>
                <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    template <span class="token operator">=</span> <span class="token string">&quot;{}\t{}\t{}\n&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span>
                    line <span class="token operator">=</span> template<span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">,</span> opr<span class="token punctuation">.</span>V<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>real<span class="token punctuation">)</span>
                    outfile<span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Outputting step: &quot;</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">calculate_energy</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> Param<span class="token punctuation">,</span> opr<span class="token punctuation">:</span> Operators<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Calculate the energy &lt;Psi|H|Psi&gt;.&quot;&quot;&quot;</span>
    <span class="token comment"># Creating real, momentum, and conjugate wavefunctions.</span>
    wfc_r <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc
    wfc_k <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fft<span class="token punctuation">(</span>wfc_r<span class="token punctuation">)</span>
    wfc_c <span class="token operator">=</span> np<span class="token punctuation">.</span>conj<span class="token punctuation">(</span>wfc_r<span class="token punctuation">)</span>

    <span class="token comment"># Finding the momentum and real-space energy terms</span>
    energy_k <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> wfc_c <span class="token operator">*</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>ifft<span class="token punctuation">(</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> wfc_k<span class="token punctuation">)</span>
    energy_r <span class="token operator">=</span> wfc_c <span class="token operator">*</span> opr<span class="token punctuation">.</span>V <span class="token operator">*</span> wfc_r

    <span class="token comment"># Integrating over all space</span>
    energy_final <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>energy_k <span class="token operator">+</span> energy_r<span class="token punctuation">)</span><span class="token punctuation">.</span>real

    <span class="token keyword">return</span> energy_final <span class="token operator">*</span> par<span class="token punctuation">.</span>dx


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    par <span class="token operator">=</span> Param<span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># Starting wavefunction slightly offset so we can see it change</span>
    opr <span class="token operator">=</span> init<span class="token punctuation">(</span>par<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.00</span><span class="token punctuation">)</span>
    split_op<span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span>

    energy <span class="token operator">=</span> calculate_energy<span class="token punctuation">(</span>par<span class="token punctuation">,</span> opr<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Energy is: &quot;</span><span class="token punctuation">,</span> energy<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
</div><div class="code-method-sample" data-lang="hs" data-name="Haskell"><pre class="language-"><code class="lang-haskell"><span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Array<span class="token punctuation">.</span>CArray</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>Complex</span>
<span class="token import-statement"><span class="token keyword">import</span> Data<span class="token punctuation">.</span>List</span> <span class="token punctuation">(</span><span class="token hvariable">intercalate</span><span class="token punctuation">,</span> <span class="token hvariable">transpose</span><span class="token punctuation">)</span>
<span class="token import-statement"><span class="token keyword">import</span> Math<span class="token punctuation">.</span>FFT</span> <span class="token punctuation">(</span><span class="token hvariable">dft</span><span class="token punctuation">,</span> <span class="token hvariable">idft</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> <span class="token constant">Vector</span> <span class="token operator">=</span> <span class="token constant">CArray</span> <span class="token constant">Int</span> <span class="token punctuation">(</span><span class="token constant">Complex</span> <span class="token constant">Double</span><span class="token punctuation">)</span>

<span class="token punctuation">(</span><span class="token operator">.*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">.+</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token constant">Vector</span> <span class="token operator">-&gt;</span> <span class="token constant">Vector</span> <span class="token operator">-&gt;</span> <span class="token constant">Vector</span>
<span class="token hvariable">a</span> <span class="token operator">.*</span> <span class="token hvariable">b</span> <span class="token operator">=</span> <span class="token hvariable">liftArray2</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span>
<span class="token hvariable">a</span> <span class="token operator">.+</span> <span class="token hvariable">b</span> <span class="token operator">=</span> <span class="token hvariable">liftArray2</span> <span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">)</span> <span class="token hvariable">a</span> <span class="token hvariable">b</span>

<span class="token hvariable">normalize</span> <span class="token operator">::</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Vector</span> <span class="token operator">-&gt;</span> <span class="token constant">Vector</span>
<span class="token hvariable">normalize</span> <span class="token hvariable">dx</span> <span class="token hvariable">v</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token hvariable">factor</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token builtin">sqrt</span> <span class="token hvariable">dx</span> <span class="token operator">/</span> <span class="token hvariable">norm2</span> <span class="token hvariable">v</span> <span class="token operator">:+</span> <span class="token number">0</span>
   <span class="token keyword">in</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token hvariable">factor</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token hvariable">v</span>

<span class="token keyword">data</span> <span class="token constant">Parameters</span> <span class="token operator">=</span> <span class="token constant">Parameters</span>
  <span class="token punctuation">{</span> <span class="token hvariable">xmax</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">res</span> <span class="token operator">::</span> <span class="token constant">Int</span>
  <span class="token punctuation">,</span> <span class="token hvariable">dt</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">timesteps</span> <span class="token operator">::</span> <span class="token constant">Int</span>
  <span class="token punctuation">,</span> <span class="token hvariable">dx</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">x</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">dk</span> <span class="token operator">::</span> <span class="token constant">Double</span>
  <span class="token punctuation">,</span> <span class="token hvariable">ks</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">imTime</span> <span class="token operator">::</span> <span class="token constant">Bool</span>
  <span class="token punctuation">}</span>

<span class="token hvariable">defaultParameters</span> <span class="token operator">::</span> <span class="token constant">Parameters</span>
<span class="token hvariable">defaultParameters</span> <span class="token operator">=</span> <span class="token hvariable">makeParameters</span> <span class="token number">10</span> <span class="token number">512</span> <span class="token number">0.01</span> <span class="token number">1000</span> <span class="token constant">True</span>

<span class="token hvariable">makeParameters</span> <span class="token operator">::</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Int</span> <span class="token operator">-&gt;</span> <span class="token constant">Bool</span> <span class="token operator">-&gt;</span> <span class="token constant">Parameters</span>
<span class="token hvariable">makeParameters</span> <span class="token hvariable">xmax</span> <span class="token hvariable">res</span> <span class="token hvariable">dt</span> <span class="token hvariable">timesteps</span> <span class="token hvariable">imTime</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token hvariable">fi</span> <span class="token operator">=</span> <span class="token builtin">fromIntegral</span>
      <span class="token hvariable">rng</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">res</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token hvariable">ks</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token operator">..</span> <span class="token builtin">div</span> <span class="token hvariable">res</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">++</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token builtin">div</span> <span class="token hvariable">res</span> <span class="token number">2</span> <span class="token operator">..</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
   <span class="token keyword">in</span> <span class="token constant">Parameters</span>
        <span class="token hvariable">xmax</span>
        <span class="token hvariable">res</span>
        <span class="token hvariable">dt</span>
        <span class="token hvariable">timesteps</span>
        <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token hvariable">xmax</span> <span class="token operator">/</span> <span class="token hvariable">fi</span> <span class="token hvariable">res</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token hvariable">listArray</span> <span class="token hvariable">rng</span> <span class="token operator">$</span>
         <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">n</span> <span class="token operator">-&gt;</span> <span class="token hvariable">xmax</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token hvariable">fi</span> <span class="token hvariable">n</span> <span class="token operator">/</span> <span class="token hvariable">fi</span> <span class="token hvariable">res</span><span class="token punctuation">)</span> <span class="token operator">:+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">..</span> <span class="token hvariable">res</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token builtin">pi</span> <span class="token operator">/</span> <span class="token hvariable">xmax</span><span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token hvariable">listArray</span> <span class="token hvariable">rng</span> <span class="token operator">$</span> <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">:+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token builtin">pi</span> <span class="token operator">/</span> <span class="token hvariable">xmax</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">fi</span><span class="token punctuation">)</span> <span class="token hvariable">ks</span><span class="token punctuation">)</span>
        <span class="token hvariable">imTime</span>

<span class="token keyword">data</span> <span class="token constant">Operators</span> <span class="token operator">=</span> <span class="token constant">Operators</span>
  <span class="token punctuation">{</span> <span class="token hvariable">v</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">rStep</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">kStep</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">,</span> <span class="token hvariable">wfc</span> <span class="token operator">::</span> <span class="token constant">Vector</span>
  <span class="token punctuation">}</span>

<span class="token hvariable">makeOperators</span> <span class="token operator">::</span> <span class="token constant">Parameters</span> <span class="token operator">-&gt;</span> <span class="token constant">Complex</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Complex</span> <span class="token constant">Double</span> <span class="token operator">-&gt;</span> <span class="token constant">Operators</span>
<span class="token hvariable">makeOperators</span> <span class="token hvariable">param</span> <span class="token hvariable">v0</span> <span class="token hvariable">wfc0</span> <span class="token operator">=</span>
  <span class="token keyword">let</span> <span class="token hvariable">rng</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token hvariable">res</span> <span class="token hvariable">param</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token hvariable">time</span>
        <span class="token operator">|</span> <span class="token hvariable">imTime</span> <span class="token hvariable">param</span> <span class="token operator">=</span> <span class="token hvariable">dt</span> <span class="token hvariable">param</span> <span class="token operator">:+</span> <span class="token number">0</span>
        <span class="token operator">|</span> <span class="token builtin">otherwise</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">:+</span> <span class="token hvariable">dt</span> <span class="token hvariable">param</span>
      <span class="token hvariable">v</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token operator">-</span> <span class="token hvariable">v0</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
      <span class="token hvariable">rStep</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token hvariable">time</span> <span class="token operator">*</span> <span class="token hvariable">x</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token hvariable">v</span>
      <span class="token hvariable">kStep</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">k</span> <span class="token operator">-&gt;</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span> <span class="token operator">*</span> <span class="token hvariable">time</span> <span class="token operator">*</span> <span class="token hvariable">k</span> <span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">ks</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
      <span class="token hvariable">wfc</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token operator">\</span><span class="token hvariable">x</span> <span class="token operator">-&gt;</span> <span class="token builtin">exp</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token operator">-</span> <span class="token hvariable">wfc0</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">x</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
   <span class="token keyword">in</span> <span class="token constant">Operators</span> <span class="token hvariable">v</span> <span class="token hvariable">rStep</span> <span class="token hvariable">kStep</span> <span class="token punctuation">(</span><span class="token hvariable">normalize</span> <span class="token punctuation">(</span><span class="token hvariable">dx</span> <span class="token hvariable">param</span><span class="token punctuation">)</span> <span class="token hvariable">wfc</span><span class="token punctuation">)</span>

<span class="token hvariable">evolve</span> <span class="token operator">::</span> <span class="token constant">Parameters</span> <span class="token operator">-&gt;</span> <span class="token constant">Operators</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token constant">Operators</span><span class="token punctuation">]</span>
<span class="token hvariable">evolve</span> <span class="token hvariable">param</span> <span class="token hvariable">op</span><span class="token operator">@</span><span class="token punctuation">(</span><span class="token constant">Operators</span> <span class="token hvariable">_</span> <span class="token hvariable">rStep</span> <span class="token hvariable">kStep</span> <span class="token hvariable">_</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">iterate</span> <span class="token hvariable">splitop</span> <span class="token hvariable">op</span>
  <span class="token keyword">where</span>
    <span class="token hvariable">splitop</span> <span class="token hvariable">op</span> <span class="token operator">=</span> <span class="token hvariable">op</span> <span class="token punctuation">{</span><span class="token hvariable">wfc</span> <span class="token operator">=</span> <span class="token hvariable">wfc&apos;</span> <span class="token hvariable">op</span><span class="token punctuation">}</span>
    <span class="token hvariable">wfc&apos;</span> <span class="token operator">=</span> <span class="token hvariable">norm</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">rStep</span> <span class="token operator">.*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">idft</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">kStep</span> <span class="token operator">.*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">dft</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">rStep</span> <span class="token operator">.*</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">wfc</span>
    <span class="token hvariable">norm</span> <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token hvariable">imTime</span> <span class="token hvariable">param</span> <span class="token keyword">then</span> <span class="token hvariable">normalize</span> <span class="token punctuation">(</span><span class="token hvariable">dx</span> <span class="token hvariable">param</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token builtin">id</span>

<span class="token hvariable">calculateEnergy</span> <span class="token operator">::</span> <span class="token constant">Parameters</span> <span class="token operator">-&gt;</span> <span class="token constant">Operators</span> <span class="token operator">-&gt;</span> <span class="token constant">Double</span>
<span class="token hvariable">calculateEnergy</span> <span class="token hvariable">param</span> <span class="token hvariable">ops</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span> <span class="token hvariable">dx</span> <span class="token hvariable">param</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token builtin">sum</span> <span class="token operator">.</span> <span class="token builtin">map</span> <span class="token hvariable">realPart</span> <span class="token operator">$</span> <span class="token hvariable">elems</span> <span class="token hvariable">totalE</span>
  <span class="token keyword">where</span>
    <span class="token hvariable">totalE</span> <span class="token operator">=</span> <span class="token hvariable">potentialE</span> <span class="token operator">.+</span> <span class="token hvariable">kineticE</span>
    <span class="token hvariable">potentialE</span> <span class="token operator">=</span> <span class="token hvariable">wfcConj</span> <span class="token operator">.*</span> <span class="token hvariable">v</span> <span class="token hvariable">ops</span> <span class="token operator">.*</span> <span class="token hvariable">wfc</span> <span class="token hvariable">ops</span>
    <span class="token hvariable">kineticOp</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token hvariable">ks</span> <span class="token hvariable">param</span><span class="token punctuation">)</span>
    <span class="token hvariable">kineticE</span> <span class="token operator">=</span> <span class="token hvariable">wfcConj</span> <span class="token operator">.*</span> <span class="token hvariable">idft</span> <span class="token punctuation">(</span><span class="token hvariable">kineticOp</span> <span class="token operator">.*</span> <span class="token hvariable">dft</span> <span class="token punctuation">(</span><span class="token hvariable">wfc</span> <span class="token hvariable">ops</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token hvariable">wfcConj</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token hvariable">conjugate</span> <span class="token operator">$</span> <span class="token hvariable">wfc</span> <span class="token hvariable">ops</span>

<span class="token comment">-- Use gnuplot to make an animated  GIF using ../gnuplot/plot_output.plt</span>
<span class="token comment">-- $ gnuplot -e &quot;folder=&apos;../haskell&apos;&quot; plot_output.plt</span>
<span class="token hvariable">printEvolution</span> <span class="token operator">::</span> <span class="token constant">Parameters</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token constant">Operators</span><span class="token punctuation">]</span> <span class="token operator">-&gt;</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">printEvolution</span> <span class="token hvariable">param</span> <span class="token operator">=</span>
  <span class="token builtin">mapM_</span> <span class="token punctuation">(</span><span class="token hvariable">export</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token hvariable">format</span> <span class="token operator">&lt;$&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token builtin">zip</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token operator">..</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token builtin">take</span> <span class="token number">100</span> <span class="token operator">.</span> <span class="token hvariable">skip</span>
  <span class="token keyword">where</span>
    <span class="token hvariable">skip</span> <span class="token punctuation">(</span><span class="token hvariable">x</span><span class="token operator">:</span><span class="token hvariable">xs</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">x</span> <span class="token operator">:</span> <span class="token hvariable">skip</span> <span class="token punctuation">(</span><span class="token builtin">drop</span> <span class="token punctuation">(</span><span class="token builtin">div</span> <span class="token punctuation">(</span><span class="token hvariable">timesteps</span> <span class="token hvariable">param</span><span class="token punctuation">)</span> <span class="token number">100</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token hvariable">xs</span><span class="token punctuation">)</span>
    <span class="token hvariable">format</span> <span class="token punctuation">(</span><span class="token constant">Operators</span> <span class="token hvariable">v</span> <span class="token hvariable">_</span> <span class="token hvariable">_</span> <span class="token hvariable">wfc</span><span class="token punctuation">)</span> <span class="token operator">=</span>
      <span class="token keyword">let</span> <span class="token hvariable">density</span> <span class="token operator">=</span> <span class="token hvariable">liftArray</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">^</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token builtin">abs</span><span class="token punctuation">)</span> <span class="token hvariable">wfc</span>
          <span class="token hvariable">values</span> <span class="token operator">=</span> <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token builtin">show</span> <span class="token operator">.</span> <span class="token hvariable">realPart</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token hvariable">elems</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token hvariable">x</span> <span class="token hvariable">param</span><span class="token punctuation">,</span> <span class="token hvariable">density</span><span class="token punctuation">,</span> <span class="token hvariable">v</span><span class="token punctuation">]</span>
       <span class="token keyword">in</span> <span class="token hvariable">intercalate</span> <span class="token string">&quot;\n&quot;</span> <span class="token operator">$</span> <span class="token builtin">map</span> <span class="token punctuation">(</span><span class="token hvariable">intercalate</span> <span class="token string">&quot;\t&quot;</span><span class="token punctuation">)</span> <span class="token operator">$</span> <span class="token hvariable">transpose</span> <span class="token hvariable">values</span>
    <span class="token hvariable">export</span> <span class="token punctuation">(</span><span class="token hvariable">i</span><span class="token punctuation">,</span> <span class="token hvariable">f</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">writeFile</span> <span class="token punctuation">(</span><span class="token string">&quot;output&quot;</span> <span class="token operator">++</span> <span class="token hvariable">pad</span> <span class="token punctuation">(</span><span class="token builtin">show</span> <span class="token hvariable">i</span><span class="token punctuation">)</span> <span class="token operator">++</span> <span class="token string">&quot;.dat&quot;</span><span class="token punctuation">)</span> <span class="token hvariable">f</span>
    <span class="token hvariable">pad</span> <span class="token hvariable">n</span> <span class="token operator">=</span> <span class="token builtin">replicate</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span> <span class="token builtin">length</span> <span class="token hvariable">n</span><span class="token punctuation">)</span> <span class="token char string">&apos;0&apos;</span> <span class="token operator">++</span> <span class="token hvariable">n</span>

<span class="token hvariable">main</span> <span class="token operator">::</span> <span class="token constant">IO</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token keyword">do</span>
  <span class="token keyword">let</span> <span class="token hvariable">p</span> <span class="token operator">=</span> <span class="token hvariable">defaultParameters</span>
      <span class="token hvariable">o</span> <span class="token operator">=</span> <span class="token hvariable">makeOperators</span> <span class="token hvariable">p</span> <span class="token number">0</span> <span class="token number">4</span>
      <span class="token hvariable">evol</span> <span class="token operator">=</span> <span class="token hvariable">evolve</span> <span class="token hvariable">p</span> <span class="token hvariable">o</span>
  <span class="token builtin">print</span> <span class="token operator">$</span> <span class="token hvariable">calculateEnergy</span> <span class="token hvariable">p</span> <span class="token punctuation">(</span><span class="token hvariable">evol</span> <span class="token operator">!!</span> <span class="token hvariable">timesteps</span> <span class="token hvariable">p</span><span class="token punctuation">)</span>
  <span class="token hvariable">printEvolution</span> <span class="token hvariable">p</span> <span class="token hvariable">evol</span>
</code></pre>
</div><div class="code-method-sample" data-lang="rs" data-name="Rust"><pre class="language-"><code class="lang-rust"><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">num</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">rustfft</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">num<span class="token punctuation">::</span>complex<span class="token punctuation">::</span></span><span class="token class-name">Complex</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">rustfft<span class="token punctuation">::</span></span><span class="token class-name">FFTplanner</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token keyword">f64</span><span class="token punctuation">::</span><span class="token namespace">consts<span class="token punctuation">::</span></span><span class="token constant">PI</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Write</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>

<span class="token comment">// This implementation is based on the C and C++ implementations.</span>

<span class="token attribute attr-name">#[derive(Clone)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Parameters</span> <span class="token punctuation">{</span>
    xmax<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    res<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    dt<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    timesteps<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
    dx<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    x<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    dk<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    k<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    im_time<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Parameters</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>xmax<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> dt<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> timesteps<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span> im_time<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Parameters</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> dx <span class="token operator">=</span> <span class="token number">2.0_f64</span> <span class="token operator">*</span> xmax <span class="token operator">/</span> <span class="token punctuation">(</span>res <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> x<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> dk <span class="token operator">=</span> <span class="token constant">PI</span> <span class="token operator">/</span> xmax<span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> k<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>res <span class="token punctuation">{</span>
            x<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>xmax <span class="token operator">/</span> <span class="token punctuation">(</span>res <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">-</span> xmax <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">*</span> dx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> i <span class="token punctuation">{</span>
                i <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> res <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI</span> <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
                _ <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>res <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">PI</span> <span class="token operator">/</span> xmax<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Parameters</span> <span class="token punctuation">{</span>
            xmax<span class="token punctuation">,</span>
            res<span class="token punctuation">,</span>
            dt<span class="token punctuation">,</span>
            timesteps<span class="token punctuation">,</span>
            im_time<span class="token punctuation">,</span>
            dx<span class="token punctuation">,</span>
            x<span class="token punctuation">,</span>
            dk<span class="token punctuation">,</span>
            k<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Operators</span> <span class="token punctuation">{</span>
    v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    pe<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    ke<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    wfc<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Operators</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Parameters</span><span class="token punctuation">,</span> v_offset<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span> wfc_offset<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Operators</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pe<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> ke<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> wfc<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">with_capacity</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            v<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                <span class="token number">0.5_f64</span> <span class="token operator">*</span> <span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> v_offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wfc<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> wfc_offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                ke<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>
                    <span class="token number">0.0_f64</span><span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pe<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5_f64</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dt <span class="token operator">*</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Operators</span> <span class="token punctuation">{</span> v<span class="token punctuation">,</span> pe<span class="token punctuation">,</span> ke<span class="token punctuation">,</span> wfc <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">fft</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Complex</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> inverse<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> y <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> p <span class="token operator">=</span> <span class="token class-name">FFTplanner</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>inverse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fft <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">plan_fft</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fft<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> y<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">split_op</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Parameters</span><span class="token punctuation">,</span> opr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">Operators</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> density<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>timesteps <span class="token punctuation">{</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>ke<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fft</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*=</span> opr<span class="token punctuation">.</span>pe<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        density <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> x<span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> par<span class="token punctuation">.</span>im_time <span class="token punctuation">{</span>
            <span class="token keyword">let</span> sum <span class="token operator">=</span> density<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> par<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>

            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
                opr<span class="token punctuation">.</span>wfc<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/=</span> sum<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Writing data into a file in the format of:</span>
        <span class="token comment">// index, density, real potential.</span>
        <span class="token keyword">let</span> path_name <span class="token operator">=</span> <span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;output{}.dat&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> display <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> file <span class="token operator">=</span> <span class="token keyword">match</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&apos;t create {}: {}&quot;</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span> why<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>good<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> good<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token macro property">writeln!</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;{}\t{}\t{}&quot;</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> density<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&apos;t write to {}: {}&quot;</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span> why<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>why<span class="token punctuation">)</span> <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">panic!</span><span class="token punctuation">(</span><span class="token string">&quot;Couldn&apos;t flush {}: {}&quot;</span><span class="token punctuation">,</span> display<span class="token punctuation">,</span> why<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">calculate_energy</span><span class="token punctuation">(</span>par<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Parameters</span><span class="token punctuation">,</span> opr<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Operators</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">f64</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> wfc_r <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> wfc_k <span class="token operator">=</span> opr<span class="token punctuation">.</span>wfc<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> wfc_c <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> par<span class="token punctuation">.</span>res<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">fft</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> wfc_k<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
        wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">conj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> energy_k <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> par<span class="token punctuation">.</span>res<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> energy_r <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> par<span class="token punctuation">.</span>res<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
        energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token class-name">Complex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>par<span class="token punctuation">.</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0_f64</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">powi</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fft</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> energy_k<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>par<span class="token punctuation">.</span>res <span class="token punctuation">{</span>
        energy_k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*=</span> wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span><span class="token number">0.5_f64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        energy_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> wfc_c<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> opr<span class="token punctuation">.</span>v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> wfc_r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> energy_final <span class="token operator">=</span> energy_k
        <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>energy_r<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token number">0.0_f64</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>acc<span class="token punctuation">,</span> x<span class="token closure-punctuation punctuation">|</span></span> acc <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token number">.0</span> <span class="token operator">+</span> x<span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>re<span class="token punctuation">)</span><span class="token punctuation">;</span>

    energy_final <span class="token operator">*</span> par<span class="token punctuation">.</span>dx
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> par <span class="token operator">=</span> <span class="token class-name">Parameters</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> opr <span class="token operator">=</span> <span class="token class-name">Operators</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>par<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">split_op</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>par<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> opr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The energy is {}&quot;</span><span class="token punctuation">,</span> <span class="token function">calculate_energy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>par<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div></div></div>

<script>
MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
</script>

<h2 id="license">License</h2>
<h5 id="code-examples">Code Examples</h5>
<p>The code examples are licensed under the MIT license (found in <a href="https://github.com/algorithm-archivists/algorithm-archive/blob/master/LICENSE.md" target="_blank">LICENSE.md</a>).</p>
<h5 id="text">Text</h5>
<p>The text of this chapter was written by <a href="https://github.com/leios" target="_blank">James Schloss</a> and is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<p><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank"><p><img class="center" src="../cc/CC-BY-SA_icon.svg"></p></a></p>
<h5 id="imagesgraphics">Images/Graphics</h5>
<ul>
<li>The image &quot;<a href="res/split_op_method.svg">split_op_method</a>&quot; was created by <a href="https://github.com/julianschacher" target="_blank">Julian Schacher</a> and is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</li>
<li>The animation &quot;<a href="res/real_time.gif">realsplitop</a>&quot; was created by <a href="https://github.com/leios" target="_blank">James Schloss</a> and is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</li>
<li>The animation &quot;<a href="res/imaginary_time.gif">imaginarysplitop</a>&quot; was created by <a href="https://github.com/leios" target="_blank">James Schloss</a> and is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</li>
</ul>
<h5 id="pull-requests">Pull Requests</h5>
<p>After initial licensing (<a href="https://github.com/algorithm-archivists/algorithm-archive/pull/560" target="_blank">#560</a>), the following pull requests have modified the text or graphics of this chapter:</p>
<ul>
<li>none</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../quantum_systems/quantum_systems.html" class="navigation navigation-prev " aria-label="Previous page: Quantum Systems">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../data_compression/data_compression.html" class="navigation navigation-next " aria-label="Next page: Data Compression">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Split-Operator Method","level":"1.15.2.1","depth":3,"next":{"title":"Data Compression","level":"1.16","depth":1,"path":"contents/data_compression/data_compression.md","ref":"contents/data_compression/data_compression.md","articles":[{"title":"Huffman Encoding","level":"1.16.1","depth":2,"path":"contents/huffman_encoding/huffman_encoding.md","ref":"contents/huffman_encoding/huffman_encoding.md","articles":[]}]},"previous":{"title":"Quantum Systems","level":"1.15.2","depth":2,"path":"contents/quantum_systems/quantum_systems.md","ref":"contents/quantum_systems/quantum_systems.md","articles":[{"title":"Split-Operator Method","level":"1.15.2.1","depth":3,"path":"contents/split-operator_method/split-operator_method.md","ref":"contents/split-operator_method/split-operator_method.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["mathjax@https://github.com/algorithm-archivists/plugin-mathjax","bibtex-cite","wordcount","api-language-selector@https://github.com/algorithm-archivists/gitbook-plugin-api-language-selector.git","include-codeblock","bulk-redirect","prism","-highlight"],"root":"./","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"api-language-selector":{"languages":[{"lang":"jl","name":"Julia","default":true},{"lang":"bash","name":"Bash"},{"lang":"cs","name":"C#"},{"lang":"cpp","name":"C++"},{"lang":"c","name":"C"},{"lang":"c8","name":"chip-8"},{"lang":"py","name":"Python"},{"lang":"js","name":"JavaScript"},{"lang":"scratch","name":"Scratch"},{"lang":"hs","name":"Haskell"},{"lang":"rs","name":"Rust"},{"lang":"ml","name":"OCaml"},{"lang":"java","name":"Java"},{"lang":"clj","name":"Clojure"},{"lang":"elm","name":"Elm"},{"lang":"LabVIEW","name":"LabVIEW"},{"lang":"d","name":"D"},{"lang":"go","name":"Go"},{"lang":"swift","name":"Swift"},{"lang":"racket","name":"Racket"},{"lang":"m","name":"Matlab"},{"lang":"r","name":"R"},{"lang":"ti83b","name":"TI-83 Basic"},{"lang":"lua","name":"Lua"},{"lang":"crystal","name":"Crystal"},{"lang":"php","name":"PHP"},{"lang":"lisp","name":"Common Lisp"},{"lang":"nim","name":"Nim"},{"lang":"asm-x64","name":"X86-64 Assembly"},{"lang":"f90","name":"Fortran90"},{"lang":"factor","name":"Factor"},{"lang":"ws","name":"Whitespace"},{"lang":"scala","name":"Scala"},{"lang":"emojic","name":"Emojicode"},{"lang":"lolcode","name":"LOLCODE"},{"lang":"piet","name":"Piet"},{"lang":"ss","name":"Scheme"},{"lang":"ps1","name":"PowerShell"},{"lang":"v","name":"Vlang"},{"lang":"coffee","name":"CoffeeScript"},{"lang":"kotlin","name":"Kotlin"},{"lang":"ts","name":"TypeScript"},{"lang":"vim","name":"VimL"},{"lang":"coco","name":"Coconut"},{"lang":"dart","name":"Dart"}]},"prism":{"lang":{"asm-x64":"nasm"},"ignore":["emojicode","text"],"css":["prismjs/themes/prism-tomorrow.css"]},"wordcount":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"bulk-redirect":{"basepath":"/","redirectsFile":"redirects.json"},"bibtex-cite":{},"mathjax":{"forceSVG":false,"version":"2.6.1"},"include-codeblock":{"check":false,"edit":false,"lang":"","fixlang":true,"template":"default","theme":"chrome","unindent":true},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","lunr":{"maxIndexSize":1000000000},"honkit":">= 3.0.0","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"bibCount":0,"variables":{},"title":"Arcane Algorithm Archive","bib":[{"citationKey":"CT1965","entryType":"ARTICLE","entryTags":{"TITLE":"An algorithm for the machine calculation of complex Fourier series","AUTHOR":"Cooley, James W and Tukey, John W","JOURNAL":"Mathematics of computation","VOLUME":"19","NUMBER":"90","PAGES":"297--301","YEAR":"1965","PUBLISHER":"JSTOR"}},{"citationKey":"JM1973","entryType":"ARTICLE","entryTags":{"TITLE":"On the identification of the convex hull of a finite set of points in the plane","AUTHOR":"Jarvis, Ray A","JOURNAL":"Information processing letters","VOLUME":"2","NUMBER":"1","PAGES":"18--21","YEAR":"1973","PUBLISHER":"Elsevier"}},{"citationKey":"GS1972","entryType":"ARTICLE","entryTags":{"TITLE":"An efficient algorithm for determining the convex hull of a finite planar set","AUTHOR":"Graham, Ronald L","JOURNAL":"Information processing letters","VOLUME":"1","NUMBER":"4","PAGES":"132--133","YEAR":"1972","PUBLISHER":"Elsevier"}},{"citationKey":"GNUPLOT","entryType":"MISC","entryTags":{"TITLE":"Gnuplot 5.0: An Interactive Plotting Program, Official Gnuplot Documentation","AUTHOR":"Williams, T and Kelley, C","YEAR":"2015"}},{"citationKey":"BEDE725","entryType":"BOOK","entryTags":{"TITLE":"Bede, the Reckoning of Time","AUTHOR":"Venerabilis, Beda and others","VOLUME":"29","YEAR":"1999","PUBLISHER":"Liverpool University Press"}},{"citationKey":"DICTCOMPUTUS","entryType":"MISC","entryTags":{"TITLE":"Dictionary.com definition of computus","URL":"https://www.merriam-webster.com/dictionary/computus","YEAR":"2020"}},{"citationKey":"COMPUTUS1876","entryType":"ARTICLE","entryTags":{"TITLE":"To find Easter: a new York correspondent sends us the following","AUTHOR":"unknown","JOURNAL":"Nature","YEAR":"1876"}},{"citationKey":"BIEN2004","entryType":"ARTICLE","entryTags":{"TITLE":"Gauss and beyond: The making of Easter algorithms","AUTHOR":"Bien, Reinhold","JOURNAL":"Archive for history of exact sciences","VOLUME":"58","NUMBER":"5","PAGES":"439--452","YEAR":"2004","PUBLISHER":"Springer"}},{"citationKey":"SERVOIS","entryType":"INPROCEEDINGS","entryTags":{"TITLE":"84 Calendrier","AUTHOR":"Servois, M","BOOKTITLE":"Annales de Mathématiques pures et appliquées","VOLUME":"4","NUMBER":"1813-1814","PAGES":"84--90"}},{"citationKey":"STANDISH2004","entryType":"ARTICLE","entryTags":{"TITLE":"The astronomical unit now","AUTHOR":"Standish, EM","JOURNAL":"Proceedings of the International Astronomical Union","VOLUME":"2004","NUMBER":"IAUC196","PAGES":"163--179","YEAR":"2004","PUBLISHER":"Cambridge University Press"}},{"citationKey":"LUNAR_MONTH_WIKI","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: Lunar Month","URL":"https://en.wikipedia.org/wiki/Lunar_month","YEAR":"2020"}},{"citationKey":"SELF-SIMILAR","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: Self-similarity","URL":"https://en.wikipedia.org/wiki/Self-similarity","YEAR":"2019"}},{"citationKey":"HAUSDORFF","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: Hausdorff dimension","URL":"https://en.wikipedia.org/wiki/Hausdorff_dimension","YEAR":"2019"}},{"citationKey":"3B1BFRACTAL","entryType":"MISC","entryTags":{"AUTHOR":"Sanderson, G","TITLE":"3blue1brown: Fractals are typically not self-similar","URL":"https://www.youtube.com/watch?v=gB9n2gHsHN4","YEAR":"2017"}},{"citationKey":"MANDELBROT1983FRACTAL","entryType":"BOOK","entryTags":{"TITLE":"The fractal geometry of nature","AUTHOR":"Mandelbrot, Benoit B","VOLUME":"173","YEAR":"1983","PUBLISHER":"WH freeman New York"}},{"citationKey":"MANDELBROT1967LONG","entryType":"ARTICLE","entryTags":{"TITLE":"How long is the coast of Britain? Statistical self-similarity and fractional dimension","AUTHOR":"Mandelbrot, Benoit","JOURNAL":"science","VOLUME":"156","NUMBER":"3775","PAGES":"636--638","YEAR":"1967","PUBLISHER":"American Association for the Advancement of Science"}},{"citationKey":"JAMPOUR2010NEW","entryType":"ARTICLE","entryTags":{"TITLE":"A new fast technique for fingerprint identification with fractal and chaos game theory","AUTHOR":"Jampour, Mahdi and Yaghoobi, Mahdi and Ashourzadeh, Maryam and Soleimani, Adel","JOURNAL":"Fractals","VOLUME":"18","NUMBER":"03","PAGES":"293--300","YEAR":"2010","PUBLISHER":"World Scientific"}},{"citationKey":"FRACTAL-COMPRESSION","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: Fractal Compression","URL":"https://en.wikipedia.org/wiki/Fractal_compression","YEAR":"2019"}},{"citationKey":"SAUPE1994REVIEW","entryType":"ARTICLE","entryTags":{"TITLE":"A review of the fractal image compression literature","AUTHOR":"Saupe, Dietmar and Hamzaoui, Raouf","JOURNAL":"ACM SIGGRAPH Computer Graphics","VOLUME":"28","NUMBER":"4","PAGES":"268--276","YEAR":"1994","PUBLISHER":"ACM"}},{"citationKey":"GNEITING2012ESTIMATORS","entryType":"ARTICLE","entryTags":{"TITLE":"Estimators of fractal dimension: Assessing the roughness of time series and spatial data","AUTHOR":"Gneiting, Tilmann and Ševčíková, Hana and Percival, Donald B","JOURNAL":"Statistical Science","PAGES":"247--277","YEAR":"2012","PUBLISHER":"JSTOR"}},{"citationKey":"HUTCHINSON1981FRACTALS","entryType":"ARTICLE","entryTags":{"TITLE":"Fractals and self similarity","AUTHOR":"Hutchinson, John E","JOURNAL":"Indiana University Mathematics Journal","VOLUME":"30","NUMBER":"5","PAGES":"713--747","YEAR":"1981","PUBLISHER":"JSTOR"}},{"citationKey":"HUTCHINSON-OPERATOR","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: Hutchinson Operator","URL":"https://en.wikipedia.org/wiki/Hutchinson_operator","YEAR":"2019"}},{"citationKey":"CHAOS-GAME","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: Chaos Game","URL":"https://en.wikipedia.org/wiki/Chaos_game","YEAR":"2019"}},{"citationKey":"CHAOS-GAME-WOLF","entryType":"MISC","entryTags":{"TITLE":"Wolfram: Chaos Game","URL":"http://mathworld.wolfram.com/ChaosGame.html","YEAR":"2019"}},{"citationKey":"BARNSLEY2014FRACTALS","entryType":"BOOK","entryTags":{"TITLE":"Fractals everywhere","AUTHOR":"Barnsley, Michael F","YEAR":"2014","PUBLISHER":"Academic press"}},{"citationKey":"HSV","entryType":"MISC","entryTags":{"TITLE":"Wikipedia: HSL and HSV","URL":"https://en.wikipedia.org/wiki/HSL_and_HSV","YEAR":"2020"}},{"citationKey":"SCHLOSS2019","entryType":"ARTICLE","entryTags":{"TITLE":"Massively parallel split-step Fourier techniques for simulating quantum systems on graphics processing units","AUTHOR":"Schloss, James","YEAR":"2019"}},{"citationKey":"PETHICK2008","entryType":"BOOK","entryTags":{"TITLE":"Bose--Einstein condensation in dilute gases","AUTHOR":"Pethick, Christopher J and Smith, Henrik","YEAR":"2008","PUBLISHER":"Cambridge university press"}},{"citationKey":"WEGERT2012","entryType":"BOOK","entryTags":{"TITLE":"Visual complex functions: an introduction with phase portraits","AUTHOR":"Wegert, Elias","YEAR":"2012","PUBLISHER":"Springer Science \\& Business Media"}},{"citationKey":"POELKEDOMAIN","entryType":"ARTICLE","entryTags":{"TITLE":"Domain Coloring of Complex Functions","AUTHOR":"Poelke, Konstantin and Polthier, Konrad"}},{"citationKey":"LUNDMARK2004","entryType":"ARTICLE","entryTags":{"TITLE":"Visualizing complex analytic functions using domain coloring","AUTHOR":"Lundmark, Hans","JOURNAL":"Recuperado el","VOLUME":"24","YEAR":"2004"}},{"citationKey":"GIMP_BUCKET","entryType":"MISC","entryTags":{"TITLE":"Bucket Fill in Gimp","URL":"https://docs.gimp.org/2.10/en/gimp-tool-bucket-fill.html","YEAR":"2020"}},{"citationKey":"TORBERT2016","entryType":"BOOK","entryTags":{"TITLE":"Applied computer science","AUTHOR":"Torbert, Shane","YEAR":"2016","PAGES":"158","PUBLISHER":"Springer"}},{"citationKey":"CANNY1986COMPUTATIONAL","entryType":"ARTICLE","entryTags":{"TITLE":"A computational approach to edge detection","AUTHOR":"Canny, John","JOURNAL":"IEEE Transactions on pattern analysis and machine intelligence","NUMBER":"6","PAGES":"679--698","YEAR":"1986","PUBLISHER":"Ieee"}},{"citationKey":"MORRIS1978COUNTING","entryType":"ARTICLE","entryTags":{"TITLE":"Counting large numbers of events in small registers","AUTHOR":"Morris, R","JOURNAL":"Communications of the ACM","VOLUME":"21","NUMBER":"10","PAGES":"840--842","YEAR":"1978","PUBLISHER":"ACM New York, NY, USA"}},{"citationKey":"FLAJOLET1985APPROXIMATE","entryType":"ARTICLE","entryTags":{"TITLE":"Approximate counting: a detailed analysis","AUTHOR":"Flajolet, P","JOURNAL":"BIT Numerical Mathematics","VOLUME":"25","NUMBER":"1","PAGES":"113--134","YEAR":"1985","PUBLISHER":"Springer"}},{"citationKey":"ARPIT_COUNTING","entryType":"MISC","entryTags":{"TITLE":"Morris's Algorithm for Approximate Counting","AUTHOR":"Bhayani, A","URL":"https://arpitbhayani.me/blogs/morris-counter","YEAR":"2020"}},{"citationKey":"GREGGUNDERSON_COUNTING","entryType":"MISC","entryTags":{"TITLE":"Approximate Counting with Morris's Algorithm","AUTHOR":"Gundersen, G","URL":"http://gregorygundersen.com/blog/2019/11/11/morris-algorithm/","YEAR":"2019"}},{"citationKey":"3B1B_FINGER_COUNT","entryType":"MISC","entryTags":{"TITLE":"How to count to 1000 on two hands","AUTHOR":"Sanderson, G","URL":"https://youtu.be/1SMmc9gQmHQ","YEAR":"2015"}}],"gitbook":"*"},"file":{"path":"contents/split-operator_method/split-operator_method.md","mtime":"2021-10-08T11:05:39.785Z","type":"markdown"},"gitbook":{"version":"3.6.22","time":"2021-10-08T11:06:06.232Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-api-language-selector/api-language-selector.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

